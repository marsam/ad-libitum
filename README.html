<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-10-14 Sat 13:27 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ad Libitum</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Ruslan Prakapchuk" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Ad Libitum</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org551de67">1. AD LIBITUM</a></li>
<li><a href="#org0f7924b">2. Getting Started</a>
<ul>
<li><a href="#orgda5d7de">2.1. Chez Scheme</a>
<ul>
<li><a href="#org1d0c669">2.1.1. Clone Chez Scheme repository</a></li>
<li><a href="#orgb3b1435">2.1.2. Exclude X11 from dependencies</a></li>
<li><a href="#org1136882">2.1.3. Configure, build and install Chez Scheme</a></li>
<li><a href="#org61a37e3">2.1.4. Test it's working</a></li>
</ul>
</li>
<li><a href="#org5516e78">2.2. libsoundio</a></li>
<li><a href="#orgc1ea26b">2.3. PortMidi</a></li>
<li><a href="#orga261c39">2.4. Ad Libitum itself</a>
<ul>
<li><a href="#org08e73f8">2.4.1. Install</a></li>
<li><a href="#orgb0bb74d">2.4.2. Test</a></li>
<li><a href="#org5b3f466">2.4.3. Play</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org785b7dd">3. Contribution</a></li>
<li><a href="#org4cdd001">4. Kernel</a>
<ul>
<li><a href="#org751b6ef">4.1. Sound I/O</a></li>
<li><a href="#org7f3007f">4.2. Scheduler</a>
<ul>
<li><a href="#orgb6ab252">4.2.1. Pairing Heap</a></li>
</ul>
</li>
<li><a href="#orge229f1f">4.3. Remote REPL</a>
<ul>
<li><a href="#org5a165b2">4.3.1. <span class="todo TODO">TODO</span> Ensure that protocol is TCP</a></li>
<li><a href="#orgcc68669">4.3.2. Blocking vs Async sockets</a></li>
<li><a href="#org35db162">4.3.3. Open socket</a></li>
<li><a href="#org42b433f">4.3.4. Accept connections</a></li>
<li><a href="#org777eb98">4.3.5. Spawn remote REPL</a></li>
<li><a href="#org11bbe02">4.3.6. <span class="todo TODO">TODO</span> Stop loop and close socket on disconnect</a></li>
<li><a href="#orgea1ac0e">4.3.7. Start REPL server</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5c21b58">5. Core</a>
<ul>
<li><a href="#org4dd587f">5.1. Math</a></li>
<li><a href="#orgd6cc521">5.2. Generators</a></li>
<li><a href="#orgb7833f4">5.3. Envelopes</a>
<ul>
<li><a href="#orgffcd6c7">5.3.1. ADSR</a></li>
<li><a href="#org27c29a9">5.3.2. Impulse</a></li>
</ul>
</li>
<li><a href="#org573eb65">5.4. Metronome</a></li>
<li><a href="#org16aefda">5.5. Control signals</a></li>
</ul>
</li>
<li><a href="#org7636093">6. Std</a>
<ul>
<li><a href="#org6b2c233">6.1. FFT</a></li>
<li><a href="#org9734bb9">6.2. Filters</a></li>
<li><a href="#org3c4b289">6.3. Instruments</a></li>
<li><a href="#org87366ff">6.4. Scales</a></li>
<li><a href="#orgd9d4270">6.5. Rhythm</a></li>
<li><a href="#orgde7f77a">6.6. MIDI</a></li>
</ul>
</li>
<li><a href="#orge215653">7. Misc</a></li>
</ul>
</div>
</div>

<div id="outline-container-org551de67" class="outline-2">
<h2 id="org551de67"><span class="section-number-2">1</span> AD LIBITUM</h2>
<div class="outline-text-2" id="text-1">
<p>
The Scheme Live Coding Environment. Built on Chez Scheme and libsoundio.
</p>
</div>
</div>

<div id="outline-container-org0f7924b" class="outline-2">
<h2 id="org0f7924b"><span class="section-number-2">2</span> Getting Started</h2>
<div class="outline-text-2" id="text-2">
<p>
This guide describes initial setup required to produce your first piece of
digital noise with Ad Libitum. At the moment Ad Libitum is tested only on
MacOS therefore following instructions are MacOS-specific. Any feedback and
improvement for other platforms is more than welcome! Current state of Ad
Libitum dependencies is that it should be easy to port it to Linux and
moderately hard (but possible) to Windows.
</p>
</div>

<div id="outline-container-orgda5d7de" class="outline-3">
<h3 id="orgda5d7de"><span class="section-number-3">2.1</span> Chez Scheme</h3>
<div class="outline-text-3" id="text-2-1">
<p>
First, you need Chez Scheme itself. Ad Libitum requires threaded version and
you probably don't want to install x11 dependency, that's why better to do it
from source, not brew.
</p>
</div>

<div id="outline-container-org1d0c669" class="outline-4">
<h4 id="org1d0c669"><span class="section-number-4">2.1.1</span> Clone Chez Scheme repository</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-shell">git clone https://github.com/cisco/ChezScheme.git
<span style="color: #DCDCCC; font-weight: bold;">cd</span> ChezScheme
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3b1435" class="outline-4">
<h4 id="orgb3b1435"><span class="section-number-4">2.1.2</span> Exclude X11 from dependencies</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
Open <code>c/version.h</code> file in your favorite text editor and comment out line
containing <code>libX11.dylib</code> reference:
</p>

<div class="org-src-container">
<pre class="src src-diff"><span style="color: #dddddd;">modified</span><span style="color: #D0BF8F;">   </span><span style="color: #dddddd;">c/version.h</span>
<span style="background-color: #5F5F5F;">@@</span><span style="color: #D0BF8F;"> </span><span style="background-color: #5F5F5F;">-280,7</span><span style="color: #D0BF8F;"> </span><span style="background-color: #5F5F5F;">+280,7</span><span style="color: #D0BF8F;"> </span><span style="background-color: #5F5F5F;">@@</span><span style="color: #D0BF8F;"> </span><span style="background-color: #5F5F5F;">typedef</span><span style="color: #D0BF8F;"> </span><span style="background-color: #5F5F5F;">char</span><span style="color: #D0BF8F;"> </span><span style="background-color: #5F5F5F;">*memcpy_t;</span>
<span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">typedef</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">int</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">tputsputcchar;</span>
<span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">#define</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">LOCKF</span>
<span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">#define</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">DIRMARKERP(c)</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">((c)</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">==</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">'/')</span>
<span style="color: #AC7373; background-color: #553333;">-</span><span style="color: #AC7373; background-color: #553333;">#define</span><span style="color: #D0BF8F;"> </span><span style="color: #AC7373; background-color: #553333;">LIBX11</span><span style="color: #D0BF8F;"> </span><span style="color: #AC7373; background-color: #553333;">"/usr/X11R6/lib/libX11.dylib"</span>
<span style="color: #7F9F7F; background-color: #335533;">+</span><span style="color: #7F9F7F; background-color: #335533;">/*</span><span style="color: #D0BF8F;"> </span><span style="color: #7F9F7F; background-color: #335533;">#define</span><span style="color: #D0BF8F;"> </span><span style="color: #7F9F7F; background-color: #335533;">LIBX11</span><span style="color: #D0BF8F;"> </span><span style="color: #7F9F7F; background-color: #335533;">"/usr/X11R6/lib/libX11.dylib"</span><span style="color: #D0BF8F;"> </span><span style="color: #7F9F7F; background-color: #335533;">*/</span>
<span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">#define</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">_DARWIN_USE_64_BIT_INODE</span>
<span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">#define</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">SECATIME(sb)</span><span style="color: #D0BF8F;"> </span><span style="color: #dddddd;">(sb).st_atimespec.tv_sec</span>
<span style="color: #D0BF8F;"> </span>#define<span style="color: #D0BF8F;"> </span>SECCTIME(sb)<span style="color: #D0BF8F;"> </span>(sb).st_ctimespec.tv_sec
</pre>
</div>
</div>
</div>

<div id="outline-container-org1136882" class="outline-4">
<h4 id="org1136882"><span class="section-number-4">2.1.3</span> Configure, build and install Chez Scheme</h4>
<div class="outline-text-4" id="text-2-1-3">
<div class="org-src-container">
<pre class="src src-shell">./configure --threads
make
sudo make install
</pre>
</div>
</div>
</div>

<div id="outline-container-org61a37e3" class="outline-4">
<h4 id="org61a37e3"><span class="section-number-4">2.1.4</span> Test it's working</h4>
<div class="outline-text-4" id="text-2-1-4">
<p>
Run <code>scheme</code> from terminal and try to evaluate simple expression:
</p>

<div class="org-src-container">
<pre class="src src-shell">~/ChezScheme&gt; scheme

Chez Scheme Version <span style="color: #BFEBBF;">9.4.1</span>
Copyright <span style="color: #BFEBBF;">1984-2017</span> Cisco Systems, Inc.

&gt; <span style="color: #DCDCCC;">(</span>+ <span style="color: #BFEBBF;">1</span> <span style="color: #BFEBBF;">2</span> <span style="color: #BFEBBF;">3</span><span style="color: #DCDCCC;">)</span>
<span style="color: #BFEBBF;">6</span>
&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5516e78" class="outline-3">
<h3 id="org5516e78"><span class="section-number-3">2.2</span> libsoundio</h3>
<div class="outline-text-3" id="text-2-2">
<p>
This is library used by Ad Libitum for communication with your computer's
sound system.
</p>

<div class="org-src-container">
<pre class="src src-shell">brew install libsoundio
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc1ea26b" class="outline-3">
<h3 id="orgc1ea26b"><span class="section-number-3">2.3</span> PortMidi</h3>
<div class="outline-text-3" id="text-2-3">
<p>
You need it if you plan to use MIDI controller.
</p>

<div class="org-src-container">
<pre class="src src-shell">brew install portmidi
</pre>
</div>
</div>
</div>

<div id="outline-container-orga261c39" class="outline-3">
<h3 id="orga261c39"><span class="section-number-3">2.4</span> Ad Libitum itself</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-org08e73f8" class="outline-4">
<h4 id="org08e73f8"><span class="section-number-4">2.4.1</span> Install</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
You need to clone repository and build several helping libraries.
</p>

<div class="org-src-container">
<pre class="src src-shell">git clone https://github.com/ul/ad-libitum.git
<span style="color: #DCDCCC; font-weight: bold;">cd</span> ad-libitum
git submodule update --init --recursive --remote
make
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb0bb74d" class="outline-4">
<h4 id="orgb0bb74d"><span class="section-number-4">2.4.2</span> Test</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
Fire up <code>scheme ad-libitum.ss</code> and play 440Hz tuner (beware of loud sound!
reduce speakers/headphones volume before running). Congratulations, you
livecoded your first Ad Libitum piece!
</p>

<div class="org-src-container">
<pre class="src src-scheme">~/ad-libitum&gt; scheme ad-libitum.ss

Chez Scheme Version <span style="color: #BFEBBF;">9.4.1</span>
Copyright <span style="color: #BFEBBF;">1984-2017</span> Cisco Systems, Inc.

&gt; <span style="color: #DCDCCC;">(</span>play! tuner<span style="color: #DCDCCC;">)</span>
&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b3f466" class="outline-4">
<h4 id="org5b3f466"><span class="section-number-4">2.4.3</span> Play</h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
Run &amp; <code>geiser-connect</code>
</p>

<div class="org-src-container">
<pre class="src src-shell">scheme --optimize-level <span style="color: #BFEBBF;">2</span> violet.ss
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org785b7dd" class="outline-2">
<h2 id="org785b7dd"><span class="section-number-2">3</span> Contribution</h2>
<div class="outline-text-2" id="text-3">
<p>
Contribution is more than welcome and highly appreciated! Any small or non-code
fix is valuable as well, including spelling and grammar and setting proper
licensing.
</p>
</div>
</div>

<div id="outline-container-org4cdd001" class="outline-2">
<h2 id="org4cdd001"><span class="section-number-2">4</span> Kernel</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org751b6ef" class="outline-3">
<h3 id="org751b6ef"><span class="section-number-3">4.1</span> Sound I/O</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Ad Libitum relies on <code>chez-soundio</code> bindings and high-level wrapper. We are
going to create and open default i/o (only 'o' at the moment) stream and
provide it globally.
</p>

<p>
For performance reasons <code>chez-sound</code> itself doesn't provide any protection
against broken <code>write-callback</code>. But in livecoding mistakes are the part of
exploration and arguably we want to sacrifice some performance to be able to
not restart entire sound subsystem for fixing our <code>write-callback</code>. That's
why calling <code>*dsp*</code> is wrapped into <code>guard</code>.
</p>

<p>
To keep our scheduler clock in sync with audio we store audio time and return
it from <code>now</code> function which is passed to scheduler later.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgd7a6b9d"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;sound&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*time*</span> <span style="color: #BFEBBF;">0.0</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">now</span><span style="color: #BFEBBF;">)</span> *time*<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">silence</span> time channel<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">0.0</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*dsp*</span> silence<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">set-dsp!</span> f<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *dsp* f<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">hush!</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>set-dsp! silence<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">write-callback</span> time channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *time* time<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>guard <span style="color: #D0BF8F;">(</span>_ <span style="color: #93E0E3;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #BFEBBF;">0.0</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>*dsp* time channel<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*sound-out*</span> <span style="color: #BFEBBF;">(</span>soundio:open-default-out-stream write-callback<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*sample-rate*</span> <span style="color: #BFEBBF;">(</span>soundio:sample-rate *sound-out*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*channels*</span> <span style="color: #BFEBBF;">(</span>soundio:channel-count *sound-out*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">start</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>soundio:start-out-stream *sound-out*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">stop</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>soundio:stop-out-stream *sound-out*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/sound&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f3007f" class="outline-3">
<h3 id="org7f3007f"><span class="section-number-3">4.2</span> Scheduler</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Much of music is about time. Before we produce any single sample of wave, we
want to control when to start and when to stop doing it. Much of live coding
is about decoupling our commands from their execution. We want to say "play
note a second later" now, but play it a second later. It's where scheduler
comes to play. Essentially, scheduler's API is simple and allows to get
current time mark (whatever it means: system clock, time elapsed from
scheduler start or number of rendered samples) and to callback procedure at
some point of time with more or less guaranteed skew limit.
</p>

<p>
Let's start with scheduler interface. As has been said there are two basic
functions it must provide, <code>now</code> and <code>schedule</code>. First one allows to get
current point in time, and it is usually comes to schedule from external
source like audio stream to be in sync with it. Second one allows to schedule
execution at some point in future.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org73c4db9"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;scheduler-interface&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;now&gt;&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;schedule&gt;&gt;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/scheduler-interface&gt;</span>
</pre>
</div>

<p>
As far as scheduler is stateful and even involves thread creation, it must
have two other basic methods:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orge4eab8c"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;scheduler-interface&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;start-scheduler&gt;&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;stop-scheduler&gt;&gt;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/scheduler-interface&gt;</span>
</pre>
</div>

<p>
Let's shape scheduler's data. Obviously, <code>now</code> appears here, in form of either
scheduler's own counter or function (which will get system time or related
write thread sample number). Another thing is <code>queue</code>, where <code>schedule</code> will
store callbacks. Because queuing could happen from different threads at the
same time, as well as dequeuing inside scheduler could happen together with
queuing from another thread, we need to protect it with <code>mutex</code>. We also need
<code>thread</code> id or flag or whatever used to control thread exit, because Scheme
doesn't expose <code>pthread_kill</code>. And the last one which comes to the mind at the
moment is <code>resolution</code> as a number of times per second scheduler checks the
<code>queue</code> for expired events.
</p>

<p>
Together with record definition we provide <code>simple-scheduler</code> which creates
schedule with reasonable default parameters. The only thing it accepts is
<code>now</code>, because usually you want you schedule to be in sync with external
clock.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org660f8bc"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;scheduler-record&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define-record-type</span> scheduler
  <span style="color: #BFEBBF;">(</span>fields now <span style="color: #D0BF8F;">(</span>mutable queue<span style="color: #D0BF8F;">)</span> resolution <span style="color: #D0BF8F;">(</span>mutable thread<span style="color: #D0BF8F;">)</span> mutex<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">simple-scheduler</span> now<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>make-scheduler
   now           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">now</span>
   heap/empty    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">queue</span>
   <span style="color: #BFEBBF;">250</span>           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">resolution</span>
   #f            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">thread</span>
   <span style="color: #D0BF8F;">(</span>make-mutex<span style="color: #D0BF8F;">)</span>  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">mutex</span>
   <span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/scheduler-record&gt;</span>
</pre>
</div>

<p>
Let's implement scheduler interface.
</p>

<p>
<code>now</code> then would just call <code>now</code> field:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org7796869"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;now&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">now</span> scheduler<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #D0BF8F;">(</span>scheduler-now scheduler<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/now&gt;</span>
</pre>
</div>

<p>
Event queue accepts events which must have <code>f</code> with its
<code>args</code> to execute at <code>time</code>:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org1334965"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;event-record&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define-record-type</span> event
  <span style="color: #BFEBBF;">(</span>fields time f args<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/event-record&gt;</span>
</pre>
</div>

<p>
For <code>queue</code> we need some heap implementation, I'm going to jump into <a href="#orgb6ab252">4.2.1</a>!
</p>

<p>
Mutex is used to prevent data race on insert and remove from queue happening
in different threads.
</p>

<p>
<code>schedule</code> should accept either <code>event</code> record, or its fields (and create
record by itself) to unclutter user code.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org6ab4877"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;schedule&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">schedule</span>
  <span style="color: #BFEBBF;">(</span>case-lambda
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>scheduler event<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>with-mutex <span style="color: #9FC59F;">(</span>scheduler-mutex scheduler<span style="color: #9FC59F;">)</span>
                 <span style="color: #9FC59F;">(</span>scheduler-queue-set! scheduler <span style="color: #94BFF3;">(</span>heap/insert event-time event <span style="color: #E0CF9F;">(</span>scheduler-queue scheduler<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>scheduler t f . args<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>schedule scheduler <span style="color: #9FC59F;">(</span>make-event <span style="color: #94BFF3;">(</span>inexact t<span style="color: #94BFF3;">)</span> f args<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/schedule&gt;</span>
</pre>
</div>

<p>
Processing events is just executing any expired events' functions and removing
them from the queue.
</p>

<p>
To enable dynamic temporal recursion we support event's <code>f</code> to be a symbol
referring top level function.
</p>

<p>
Of course, live events are error prone, but we don't want flawed event to blow
entire thread. Thus <code>f</code> execution is secured with <code>guard</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgbf7daa4"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;scheduler-process-events&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">process-events</span> scheduler time<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>with-mutex
   <span style="color: #D0BF8F;">(</span>scheduler-mutex scheduler<span style="color: #D0BF8F;">)</span>
   <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">next-event</span> <span style="color: #93E0E3;">()</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>event <span style="color: #E0CF9F;">(</span>heap/find-min <span style="color: #8FB28F;">(</span>scheduler-queue scheduler<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">and</span> event <span style="color: #E0CF9F;">(</span>&lt;= <span style="color: #8FB28F;">(</span>event-time event<span style="color: #8FB28F;">)</span> time<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>scheduler-queue-set!
          scheduler
          <span style="color: #E0CF9F;">(</span>heap/delete-min event-time <span style="color: #8FB28F;">(</span>scheduler-queue scheduler<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>guard <span style="color: #E0CF9F;">(</span>_ <span style="color: #8FB28F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> #f<span style="color: #8FB28F;">]</span><span style="color: #E0CF9F;">)</span>
           <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #8FB28F;">(</span><span style="color: #6CA0A3;">[</span>f <span style="color: #DCDCCC;">(</span>event-f event<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">]</span><span style="color: #8FB28F;">)</span>
             <span style="color: #8FB28F;">(</span>apply <span style="color: #6CA0A3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #DCDCCC;">(</span>symbol? f<span style="color: #DCDCCC;">)</span>
                        <span style="color: #DCDCCC;">(</span>top-level-value f<span style="color: #DCDCCC;">)</span>
                        f<span style="color: #6CA0A3;">)</span>
                    <span style="color: #6CA0A3;">(</span>event-args event<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>next-event<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/scheduler-process-events&gt;</span>
</pre>
</div>

<p>
Now it's a time for start/stop thread. Stopping thread would be just setting a
flag which I used to call "poison pill".
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgc7ce20f"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;stop-scheduler&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">stop-scheduler</span> scheduler<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>scheduler-thread-set! scheduler #f<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/stop-scheduler&gt;</span>
</pre>
</div>

<p>
Starting thread will fork and loop calling expired events. We set expire
period for a half of resolution period in future to compensate a little bit
that events could expire during <code>process-events</code>. Proper adjustment require
further investigation taking in account that audio clock is not uniform (it
moves fast inside filling audio buffer process then waits to buffer to be
available again).
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgb266699"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;start-scheduler&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">start-scheduler</span> scheduler<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>fork-thread
   <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">()</span>
     <span style="color: #93E0E3;">(</span>scheduler-thread-set! scheduler <span style="color: #9FC59F;">(</span>get-thread-id<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>resolution <span style="color: #E0CF9F;">(</span>scheduler-resolution scheduler<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
            <span style="color: #94BFF3;">[</span>expired-horizon <span style="color: #E0CF9F;">(</span>/ <span style="color: #BFEBBF;">0.5</span> resolution<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
            <span style="color: #94BFF3;">[</span>microseconds-to-sleep <span style="color: #E0CF9F;">(</span>exact <span style="color: #8FB28F;">(</span>floor <span style="color: #6CA0A3;">(</span>/ <span style="color: #BFEBBF;">1e6</span> resolution<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> <span style="color: #94BFF3;">()</span>
         <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #E0CF9F;">(</span>scheduler-thread scheduler<span style="color: #E0CF9F;">)</span>
           <span style="color: #E0CF9F;">(</span>process-events scheduler <span style="color: #8FB28F;">(</span>+ <span style="color: #6CA0A3;">(</span>now scheduler<span style="color: #6CA0A3;">)</span> expired-horizon<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span>
           <span style="color: #E0CF9F;">(</span>usleep <span style="color: #BFEBBF;">0</span> microseconds-to-sleep<span style="color: #E0CF9F;">)</span>
           <span style="color: #E0CF9F;">(</span>loop<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/start-scheduler&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org0f1d86e"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;scheduler&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;scheduler-record&gt;&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;event-record&gt;&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;scheduler-process-events&gt;&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;scheduler-interface&gt;&gt;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/scheduler&gt;</span>
</pre>
</div>

<p>
We need just a simple default scheduler at hand for Ad Libitum needs:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgafdeed3"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*scheduler*</span> #f<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">init</span> now<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *scheduler* <span style="color: #D0BF8F;">(</span>simple-scheduler now<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">start</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>start-scheduler *scheduler*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">stop</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>stop-scheduler *scheduler*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*schedule*</span> t f . args<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>schedule *scheduler* <span style="color: #D0BF8F;">(</span>make-event t f args<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*now*</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>now *scheduler*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>

<div id="outline-container-orgb6ab252" class="outline-4">
<h4 id="orgb6ab252"><span class="section-number-4">4.2.1</span> Pairing Heap</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Wikipedia's type definition for pairing heap structure looks like Scheme's
pairs (surprise =) ). Using them implementation is quite straightforward.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org40f004d"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;pairing-heap&gt;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">we do some #f-punning and don't throw on empty heaps</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">heap/empty</span> '<span style="color: #BFEBBF;">()</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">heap/find-min</span> heap<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>null? heap<span style="color: #D0BF8F;">)</span>
      #f
      <span style="color: #D0BF8F;">(</span>car heap<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">heap/merge</span> comparator h1 h2<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>null? h1<span style="color: #93E0E3;">)</span> h2<span style="color: #D0BF8F;">]</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>null? h2<span style="color: #93E0E3;">)</span> h1<span style="color: #D0BF8F;">]</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>&lt; <span style="color: #9FC59F;">(</span>comparator <span style="color: #94BFF3;">(</span>car h1<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>comparator <span style="color: #94BFF3;">(</span>car h2<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
    <span style="color: #93E0E3;">(</span>cons <span style="color: #9FC59F;">(</span>car h1<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>cons h2 <span style="color: #94BFF3;">(</span>cdr h1<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span>
    <span style="color: #93E0E3;">(</span>cons <span style="color: #9FC59F;">(</span>car h2<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>cons h1 <span style="color: #94BFF3;">(</span>cdr h2<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">heap/insert</span> comparator elem heap<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>heap/merge comparator <span style="color: #D0BF8F;">(</span>cons elem '<span style="color: #93E0E3;">()</span><span style="color: #D0BF8F;">)</span> heap<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">heap/merge-pairs</span> comparator subheaps<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>null? subheaps<span style="color: #93E0E3;">)</span> heap/empty<span style="color: #D0BF8F;">]</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>null? <span style="color: #9FC59F;">(</span>cdr subheaps<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>car subheaps<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
   <span style="color: #D0BF8F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #93E0E3;">(</span>heap/merge comparator
          <span style="color: #9FC59F;">(</span>heap/merge comparator <span style="color: #94BFF3;">(</span>car subheaps<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>cadr subheaps<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
          <span style="color: #9FC59F;">(</span>heap/merge-pairs comparator <span style="color: #94BFF3;">(</span>cddr subheaps<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">heap/delete-min</span> comparator heap<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>null? heap<span style="color: #D0BF8F;">)</span>
      heap/empty
      <span style="color: #D0BF8F;">(</span>heap/merge-pairs comparator <span style="color: #93E0E3;">(</span>cdr heap<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/pairing-heap&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge229f1f" class="outline-3">
<h3 id="orge229f1f"><span class="section-number-3">4.3</span> Remote REPL</h3>
<div class="outline-text-3" id="text-4-3">
<p>
We need own repl server because music doesn't work in geiser repl for
somewhat reason. The most universal solution would be to have REPL over
either UDP or TCP with the simplest possible protocol. We want it to be just
a carrier, everything else should happen inside editor and engine. Sadly Chez
Scheme has no sockets in its std lib. We are gonna try Aaron W. Hsu's
<a href="https://github.com/arcfide/chez-sockets">chez-sockets</a> library.
</p>

<p>
Actually, we are still able to use Geiser with our REPL server because it
supports remote REPL. See "Connecting to an external Scheme" at <a href="http://www.nongnu.org/geiser/geiser_3.html#The-REPL">docs</a>. The
only thing required for it is to load <code>scheme/chez/geiser/geiser.ss</code> into the
REPL thread.
</p>

<p>
First, let's create a TCP socket. Here we rely on assumption, that default
protocol is TCP.
</p>
</div>

<div id="outline-container-org5a165b2" class="outline-4">
<h4 id="org5a165b2"><span class="section-number-4">4.3.1</span> <span class="todo TODO">TODO</span> Ensure that protocol is TCP</h4>
</div>

<div id="outline-container-orgcc68669" class="outline-4">
<h4 id="orgcc68669"><span class="section-number-4">4.3.2</span> Blocking vs Async sockets</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Though Aaron doesn't recommend using blocking sockets, they are so much
easier for our case! No need to implement polling when waiting for
connection or receiving value.
</p>

<p>
Tried blocking sockets. They work fine by themselves, but play bad with
<code>sleep</code> called from other threads! Falling back to async sockets and polling
then.
</p>
</div>
</div>

<div id="outline-container-org35db162" class="outline-4">
<h4 id="org35db162"><span class="section-number-4">4.3.3</span> Open socket</h4>
<div class="outline-text-4" id="text-4-3-3">
<div class="org-src-container">
<pre class="src src-scheme" id="org6118090"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;open-socket&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">open-socket</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>socket <span style="color: #9FC59F;">(</span>sock:create-socket
                 sock:socket-domain/internet
                 sock:socket-type/stream
                 sock:socket-protocol/auto<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #7CB8BB;">&lt;&lt;bind-socket&gt;&gt;</span>
    <span style="color: #7CB8BB;">&lt;&lt;listen-socket&gt;&gt;</span>
    socket
    <span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/open-socket&gt;</span>
</pre>
</div>

<p>
Then we are going to listen address and port for input. We'll make it
configurable later, let's provide some sensible hardcoded defaults for now.
<i>localhost</i> is for security reasons, and <i>37146</i> is default Geiser port.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orged13f2d"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;bind-socket&gt;</span>
<span style="color: #DCDCCC;">(</span>sock:bind-socket socket <span style="color: #BFEBBF;">(</span>sock:string-&gt;internet-address <span style="color: #CC9393;">"127.0.0.1:37146"</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/bind-socket&gt;</span>
</pre>
</div>

<p>
And then let's listen for new connections!
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org1ef6a6d"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;listen-socket&gt;</span>
<span style="color: #DCDCCC;">(</span>sock:listen-socket socket <span style="color: #BFEBBF;">1024</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/listen-socket&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org42b433f" class="outline-4">
<h4 id="org42b433f"><span class="section-number-4">4.3.4</span> Accept connections</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
To actually accept new connections we are going to create new thread and
just run infinite loop with <code>accept-socket</code> inside. Remember, our socket is
non-blocking so we are to make polling to not eat all CPU by eager calls.
After accepting new connection we'll proceed it in new thread.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org35776fb"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;accept-connections&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">accept-connections</span> repl-server-socket<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>fork-thread
   <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">()</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> <span style="color: #9FC59F;">()</span>
       <span style="color: #9FC59F;">(</span>usleep <span style="color: #BFEBBF;">0</span> polling-microseconds<span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let-values</span> <span style="color: #94BFF3;">(</span><span style="color: #E0CF9F;">[</span><span style="color: #8FB28F;">(</span>socket address<span style="color: #8FB28F;">)</span> <span style="color: #8FB28F;">(</span>sock:accept-socket repl-server-socket<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> socket
           <span style="color: #E0CF9F;">(</span>printf <span style="color: #CC9393;">"New REPL @ ~s\r\n"</span> <span style="color: #8FB28F;">(</span>sock:internet-address-&gt;string address<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span>
           <span style="color: #E0CF9F;">(</span>spawn-remote-repl socket address<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span>loop<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/accept-connections&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org777eb98" class="outline-4">
<h4 id="org777eb98"><span class="section-number-4">4.3.5</span> Spawn remote REPL</h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
Every new connection accepted would spawn new thread with a REPL loop inside
it. Because we are using async sockets, we are forced to run actual loop and
poll socket for values. <i>50ms</i> should be a reasonable polling delay to keep
it responsive and not resource greedy at the same time. Also
<code>receive-from-socket</code> require to limit maximum message length. Here <i>65k</i> is
also is a kind of a guess. Chez Scheme operates UTF-8 strings and messages
are read as bytevectors from sockets, thus we need a transcoder to convert
them back and forth. Let's put all these requirements to values:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgd92ed51"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;spawn-remote-repl-options&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">polling-microseconds</span> <span style="color: #BFEBBF;">50000</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">max-chunk-length</span> <span style="color: #BFEBBF;">65536</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">code-tx</span> <span style="color: #BFEBBF;">(</span>make-transcoder <span style="color: #D0BF8F;">(</span>utf-8-codec<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>eol-style lf<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>error-handling-mode replace<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/spawn-remote-repl-options&gt;</span>
</pre>
</div>

<p>
Preparations are straightforward: define some helpers, send initial prompt,
and start loop.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org858e6ff"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;spawn-remote-repl&gt;</span>
<span style="color: #7CB8BB;">&lt;&lt;spawn-remote-repl-options&gt;&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">spawn-remote-repl</span> socket address<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>fork-thread
   <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">()</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #9FC59F;">(</span>
            <span style="color: #7CB8BB;">&lt;&lt;repl-send-helpers&gt;&gt;</span>
            <span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span>send-prompt<span style="color: #9FC59F;">)</span>
       <span style="color: #7CB8BB;">&lt;&lt;repl-loop&gt;&gt;</span>
       <span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/spawn-remote-repl&gt;</span>
</pre>
</div>

<p>
Converting messages to bytevectors and sending to proper port is quite
tedious, let's write a couple of helpers:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org2b28db7"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;repl-send-helpers&gt;</span>
<span style="color: #DCDCCC;">[</span>call-with-send-port
 <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">(</span>f<span style="color: #D0BF8F;">)</span>
   <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>response <span style="color: #94BFF3;">(</span>call-with-bytevector-output-port f code-tx<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>sock:send-to-socket socket response address<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span>
<span style="color: #DCDCCC;">[</span>send-prompt
 <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #D0BF8F;">()</span>
   <span style="color: #D0BF8F;">(</span>call-with-send-port <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>p<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>display <span style="color: #CC9393;">"&gt; "</span> p<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/repl-send-helpers&gt;</span>
</pre>
</div>

<p>
Loop starts with polling delay. For simplicity it's constant and
unconditional in the beginning of every cycle. If socket is ready and
contains non-empty message then we do evaluation and send result back.
Reading from socket is implemented via ports, look at <code>chez-socket</code>
documentation for more info.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orga6f44b5"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;repl-loop&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> <span style="color: #BFEBBF;">()</span>
  <span style="color: #BFEBBF;">(</span>usleep <span style="color: #BFEBBF;">0</span> polling-microseconds<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let-values</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span><span style="color: #9FC59F;">(</span>request address<span style="color: #9FC59F;">)</span>
                <span style="color: #9FC59F;">(</span>sock:receive-from-socket socket max-chunk-length<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">and</span> request <span style="color: #9FC59F;">(</span>positive? <span style="color: #94BFF3;">(</span>bytevector-length request<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>call-with-port
         <span style="color: #9FC59F;">(</span>open-bytevector-input-port request code-tx<span style="color: #9FC59F;">)</span>
         <span style="color: #7CB8BB;">&lt;&lt;repl-read-eval-print&gt;&gt;</span>
         <span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>loop<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/repl-loop&gt;</span>
</pre>
</div>

<p>
Our remote REPL supports multi-form messages, therefore we need inner loop to
read and process them one by one.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgcd7bc2c"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;repl-read-eval-print&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>p<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>x <span style="color: #9FC59F;">(</span>read p<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>read p<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>eof-object? x<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>printf <span style="color: #CC9393;">"&gt; ~s\r\n"</span> x<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>call-with-send-port
     <span style="color: #7CB8BB;">&lt;&lt;repl-eval-print&gt;&gt;</span>
     <span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>send-prompt<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>loop<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/repl-read-eval-print&gt;</span>
</pre>
</div>

<p>
Eval and send result back, easy, huh?
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgcf8d1c8"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;repl-eval-print&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #BFEBBF;">(</span>p<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #D0BF8F;">(</span>
         <span style="color: #7CB8BB;">&lt;&lt;repl-eval&gt;&gt;</span>
         <span style="color: #D0BF8F;">)</span>
    <span style="color: #7CB8BB;">&lt;&lt;repl-print&gt;&gt;</span>
    <span style="color: #BFEBBF;">)</span>
  <span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/repl-eval-print&gt;</span>
</pre>
</div>

<p>
Tricky part is that we want to:
</p>

<ul class="org-ul">
<li>capture output performed by evaluated form</li>
<li>capture result of form evaluated</li>
<li>don't blow up on exception and capture its message</li>
</ul>

<p>
That's why we can't just call <code>eval</code>
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org32fd875"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;repl-eval&gt;</span>
<span style="color: #DCDCCC;">[</span>result #f<span style="color: #DCDCCC;">]</span>
<span style="color: #DCDCCC;">[</span>output
 <span style="color: #BFEBBF;">(</span>with-output-to-string
   <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">()</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> result <span style="color: #9FC59F;">(</span>guard <span style="color: #94BFF3;">(</span>x <span style="color: #E0CF9F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #8FB28F;">(</span>display-condition x<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>eval x<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/repl-eval&gt;</span>
</pre>
</div>

<p>
On the other hand, sending is quite straightforward, because we need just to
write to port provided by <code>call-with-send-port</code>
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgbb03732"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;repl-print&gt;</span>
<span style="color: #DCDCCC;">(</span>printf <span style="color: #CC9393;">"| ~s\r\n"</span> output<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>printf <span style="color: #CC9393;">"&lt; ~s\r\n"</span> result<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>display output p<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>display result p<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>newline p<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/repl-print&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org11bbe02" class="outline-4">
<h4 id="org11bbe02"><span class="section-number-4">4.3.6</span> <span class="todo TODO">TODO</span> Stop loop and close socket on disconnect</h4>
</div>

<div id="outline-container-orgea1ac0e" class="outline-4">
<h4 id="orgea1ac0e"><span class="section-number-4">4.3.7</span> Start REPL server</h4>
<div class="outline-text-4" id="text-4-3-7">
<div class="org-src-container">
<pre class="src src-scheme" id="org1f5bfde"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;start-repl-server&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">start-repl-server</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>accept-connections <span style="color: #D0BF8F;">(</span>open-socket<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/start-repl-server&gt;</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org5c21b58" class="outline-2">
<h2 id="org5c21b58"><span class="section-number-2">5</span> Core</h2>
<div class="outline-text-2" id="text-5">
<p>
Woohoo! Naive <a href="#org4cdd001">4</a> draft is here and we could start to explore Core basics
of Sound. At this point Ad Libitum splits into into interwinded parts: the
framework and the book. In the framework we are going to grow all necessary
instruments for live coding. In the book we are going to use those instruments
to experiment with sound.
</p>

<p>
One of the naming principles of Ad Libitum variables and functions is that
they should have proper long self-describing name for clarity and could have
any funky alias for shortening during performance and for fun cryptic
librettos.
</p>
</div>

<div id="outline-container-org4dd587f" class="outline-3">
<h3 id="org4dd587f"><span class="section-number-3">5.1</span> Math</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Before diving into the abyss of digital music let's define several useful
basic math constants and functions.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org0f2d447"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;basic-math&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pi</span> <span style="color: #BFEBBF;">(</span>inexact <span style="color: #D0BF8F;">(</span>* <span style="color: #93E0E3;">(</span>asin <span style="color: #BFEBBF;">1.0</span><span style="color: #93E0E3;">)</span> <span style="color: #BFEBBF;">2</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">two-pi</span> <span style="color: #BFEBBF;">(</span>* <span style="color: #BFEBBF;">2.0</span> pi<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias &#960; pi<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias <span style="color: #BFEBBF;">2&#960;</span> two-pi<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">random-amplitude</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>- <span style="color: #D0BF8F;">(</span>random <span style="color: #BFEBBF;">2.0</span><span style="color: #D0BF8F;">)</span> <span style="color: #BFEBBF;">1.0</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/basic-math&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6cc521" class="outline-3">
<h3 id="orgd6cc521"><span class="section-number-3">5.2</span> Generators</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Sound is about motion. About our mean of sensing somewhat periodic motion
a.k.a waves. The higher is period, the higher is signal pitch. Waveform
determines character of signal. And irregularities determine&#x2026; Something.
Noise? Personality? We'll try to discover.
</p>

<p>
Though signal demonstration usually started with sine waveform as the most
recognizable and surprisingly pleasant one, we are going to start with
computationally simplest one (though potentially not the fastest to calculate).
</p>

<p>
Technically, the simplest generator is just a constant value, no motion,
silence. But which stands next in simplicity?
</p>

<p>
It's the signal, which is in one position half of a time and in another position
in another half. By "time" here I mean one cycle, one period of signal.
</p>

<p>
But first let define a couple of constants to start with. It's a frequency we
want to hear and its derivatives.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org2503a64"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;tuner-constants&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">tuner-frequency</span> <span style="color: #BFEBBF;">440.0</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">tuner-period</span> <span style="color: #BFEBBF;">(</span>/ tuner-frequency<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">tuner-half-period</span> <span style="color: #BFEBBF;">(</span>* <span style="color: #BFEBBF;">0.5</span> tuner-period<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/tuner-constants&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org6b6e7af"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;simplest-oscillator&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">simplest-oscillator</span> time channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>&gt; <span style="color: #93E0E3;">(</span>mod time tuner-period<span style="color: #93E0E3;">)</span> tuner-half-period<span style="color: #D0BF8F;">)</span>
      <span style="color: #BFEBBF;">1.0</span>
      -1.0<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/simplest-oscillator&gt;</span>
</pre>
</div>

<p>
Actually, this waveform is called square, because of shape. Once we'll add
visualisation library to Ad Libitum, before that try to draw function plot by hands.
</p>

<p>
Feel free to experiment with different waveforms, we will do it together
later. Let's step back and look at our example and try to come up with useful
abstraction. Our DSP callback has signature <code>f(time, channel) -&gt; amplitude</code>,
which is the basis for any audio signal. But what prevents us using audio
signals as the main medium for building sound? Nothing! It's even very handy.
Audio signals then are capable of control parameters of other signal,
naturally forming audio graph. And Chez Scheme should optimize that CSP-like
style well. But we need to think carefully ahead of time about signature
itself. What if later we want add additional information flowing every
sample? What if returning just float is not enough to express all we want?
Because it's very beautiful, that every signal could be either interpreted as
a DSP callback alone, and could be passed to other signals. But in the latter
case sometimes it's not enough to communicate between signals with a single
float. Perhaps something like <code>f(time, channel, data) -&gt; (amplitude, data)</code>
could do the job? Where structure of <code>data</code> is determined by your
application, and parent signal is responsible for using or discarding the
<code>data</code> returned by child signal. OTOH, <code>data</code> in parameters plays like a
container for some global state to survive between samples, and we could
replace it with actual global or closured state in our application. The same
thing for returned data.
</p>

<p>
Let's start with <code>f(time, channel) -&gt; amplitude</code> then and pray that we didn't
overlook something important.
</p>

<p>
To ease writing signal creators and spotting them in code let's introduce
small helper:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org57b7bdf"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;signal&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #BFEBBF;">(</span><span style="color: #DFAF8F;">signal</span> stx<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">syntax-case</span> stx <span style="color: #D0BF8F;">()</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>k body ...<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>with-syntax <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>time <span style="color: #E0CF9F;">(</span>datum-&gt;syntax #'k 'time<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
                   <span style="color: #94BFF3;">[</span>channel <span style="color: #E0CF9F;">(</span>datum-&gt;syntax #'k 'channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       #'<span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #94BFF3;">(</span>time channel<span style="color: #94BFF3;">)</span> body ...<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>alias ~&lt; signal<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #BFEBBF;">(</span><span style="color: #DFAF8F;">define-signal</span> stx<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">syntax-case</span> stx <span style="color: #D0BF8F;">()</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>k args body ...<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>with-syntax <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>time <span style="color: #E0CF9F;">(</span>datum-&gt;syntax #'k 'time<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
                   <span style="color: #94BFF3;">[</span>channel <span style="color: #E0CF9F;">(</span>datum-&gt;syntax #'k 'channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       #'<span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">args</span>
           <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #E0CF9F;">(</span>time channel<span style="color: #E0CF9F;">)</span>
             body ...<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>alias define~ define-signal<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/signal&gt;</span>
</pre>
</div>

<p>
The most basic signal is just a constant one, which is essentially created by
our shiny new syntax <code>(~&lt; amplitude)</code>. But <code>~&lt;</code> is a macro and having
function is useful for composition matters:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org778357d"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;constant&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>constant amplitude<span style="color: #BFEBBF;">)</span> amplitude<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/constant&gt;</span>
</pre>
</div>

<p>
Then we are able to define <code>silence</code> as follows:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgf013abc"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;silence&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ silence <span style="color: #BFEBBF;">0.0</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias &#8709; silence<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/silence&gt;</span>
</pre>
</div>

<p>
Quick question for self-test: what sound would <code>(~&lt; 1.0)</code> produce?
</p>

<p>
For composing signal creators we could define a helper, which is the regular
function composition!
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org08975ab"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;compose&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">compose</span> . fns<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">make-chain</span> fn chain<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> args <span style="color: #93E0E3;">(</span>call-with-values <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">cut</span> apply fn args<span style="color: #9FC59F;">)</span> chain<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>reduce make-chain values fns<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>alias &#8728; compose<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/compose&gt;</span>
</pre>
</div>

<p>
For unifying oscillators we are going to define signal which will care about
converting time to proper phase. When you deal with periodic signals it's
important to distinguish time from phase, because at different frequencies
phase would be different at the given point of time. Which is okay when
frequency of you oscillator is constant. When it's variable as in FM
synthesis, you need to track phase for your oscillator to make it behave
properly. Let's create special signal <code>phasor</code> for that purpose. It will take
<code>frequency</code> signal and <code>phase0</code> signal and return signal of phase in <code>[0, 1)</code>
half-interval.
</p>

<p>
Here we have an opportunity for a small syntactic improvement. The use-case
when signal is applied to parameters named exactly <code>time</code> and <code>channel</code> in
current scope is very common. Let's create a special syntax for it.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orge9a6e86"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #BFEBBF;">(</span><span style="color: #DFAF8F;">&lt;~</span> stx<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">syntax-case</span> stx <span style="color: #D0BF8F;">()</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>k signal<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>with-syntax <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>time <span style="color: #E0CF9F;">(</span>datum-&gt;syntax #'k 'time<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
                   <span style="color: #94BFF3;">[</span>channel <span style="color: #E0CF9F;">(</span>datum-&gt;syntax #'k 'channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       #'<span style="color: #9FC59F;">(</span>signal time channel<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
Let's use it in our phasor signal. Phasor is used so frequently that we want
to provide a small optimization for the case when frequency is known to be
constant.
</p>

<p>
Note that <code>dynamic-phasor</code> relies on being called sample by sample. Skipping
samples is okay-ish (it's like pausing phasor), but calling the same phasor
from several other signals could make it move too fast. We need additional
check to protect it.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgd1309b6"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;phasor&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">dynamic-phasor</span> frequency phase0<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>previous-times <span style="color: #9FC59F;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
        <span style="color: #93E0E3;">[</span>previous-phases <span style="color: #9FC59F;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt;
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>previous-time <span style="color: #E0CF9F;">(</span>vector-ref previous-times channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
            <span style="color: #94BFF3;">[</span>phase-delta <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #8FB28F;">(</span>&lt; previous-time time<span style="color: #8FB28F;">)</span>
                             <span style="color: #8FB28F;">(</span>/ <span style="color: #6CA0A3;">(</span>&lt;~ frequency<span style="color: #6CA0A3;">)</span> *sample-rate*<span style="color: #8FB28F;">)</span>
                             <span style="color: #BFEBBF;">0.0</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
            <span style="color: #94BFF3;">[</span>next-phase <span style="color: #E0CF9F;">(</span>-&gt; <span style="color: #8FB28F;">(</span>vector-ref previous-phases channel<span style="color: #8FB28F;">)</span>
                            <span style="color: #8FB28F;">(</span>+ phase-delta<span style="color: #8FB28F;">)</span>
                            <span style="color: #8FB28F;">(</span>mod <span style="color: #BFEBBF;">1.0</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span>vector-set! previous-times channel time<span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span>vector-set! previous-phases channel next-phase<span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span>-&gt; <span style="color: #94BFF3;">(</span>&lt;~ phase0<span style="color: #94BFF3;">)</span>
           <span style="color: #94BFF3;">(</span>+ next-phase<span style="color: #94BFF3;">)</span>
           <span style="color: #94BFF3;">(</span>mod <span style="color: #BFEBBF;">1.0</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>static-phasor frequency phase0<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>-&gt; time <span style="color: #D0BF8F;">(</span>* frequency<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>+ phase0<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>mod <span style="color: #BFEBBF;">1.0</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">phasor</span>
  <span style="color: #BFEBBF;">(</span>case-lambda
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>frequency phase0<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span>number? frequency<span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>static-phasor frequency phase0<span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>dynamic-phasor frequency phase0<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>frequency<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span>number? frequency<span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>static-phasor frequency <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>dynamic-phasor frequency &#8709;<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>alias /// phasor<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/phasor&gt;</span>
</pre>
</div>

<p>
Then basic waveforms are defined in very clean way:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orge7b30b1"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;waveforms&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>sine phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>sin <span style="color: #D0BF8F;">(</span>* <span style="color: #BFEBBF;">2&#960;</span> <span style="color: #93E0E3;">(</span>&lt;~ phase<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>cosine phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>cos <span style="color: #D0BF8F;">(</span>* <span style="color: #BFEBBF;">2&#960;</span> <span style="color: #93E0E3;">(</span>&lt;~ phase<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>square phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>&lt; <span style="color: #93E0E3;">(</span>&lt;~ phase<span style="color: #93E0E3;">)</span> <span style="color: #BFEBBF;">0.5</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #BFEBBF;">1.0</span>
      -1.0<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">when `pulse-width' is `(constant 0.5)' it's identical to `square-wave'</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>pulse pulse-width phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>&lt; <span style="color: #93E0E3;">(</span>&lt;~ phase<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>&lt;~ pulse-width<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #BFEBBF;">1.0</span>
      -1.0<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>tri phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>phase <span style="color: #9FC59F;">(</span>&lt;~ phase<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span>&lt; phase <span style="color: #BFEBBF;">0.5</span><span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>- <span style="color: #9FC59F;">(</span>* <span style="color: #BFEBBF;">4.0</span> phase<span style="color: #9FC59F;">)</span> <span style="color: #BFEBBF;">1.0</span><span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>+ <span style="color: #9FC59F;">(</span>* -4.0 phase<span style="color: #9FC59F;">)</span> <span style="color: #BFEBBF;">3.0</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>saw phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>- <span style="color: #D0BF8F;">(</span>* <span style="color: #BFEBBF;">2.0</span> <span style="color: #93E0E3;">(</span>&lt;~ phase<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span> <span style="color: #BFEBBF;">1.0</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">sampler</span> table phase<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>n <span style="color: #9FC59F;">(</span>fixnum-&gt;flonum <span style="color: #94BFF3;">(</span>vector-length table<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt; <span style="color: #93E0E3;">(</span>vector-ref table <span style="color: #9FC59F;">(</span>flonum-&gt;fixnum <span style="color: #94BFF3;">(</span>fltruncate <span style="color: #E0CF9F;">(</span>fl* <span style="color: #8FB28F;">(</span>&lt;~ phase<span style="color: #8FB28F;">)</span> n<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">sine///</span> <span style="color: #BFEBBF;">(</span>&#8728; sine phasor<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">cosine///</span> <span style="color: #BFEBBF;">(</span>&#8728; cosine phasor<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">square///</span> <span style="color: #BFEBBF;">(</span>&#8728; square phasor<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pulse///</span>
  <span style="color: #BFEBBF;">(</span>case-lambda
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>pulse-width frequency phase0<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>pulse pulse-width <span style="color: #9FC59F;">(</span>phasor frequency phase0<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>pulse-width frequency<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>pulse pulse-width <span style="color: #9FC59F;">(</span>phasor frequency &#8709;<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">tri///</span> <span style="color: #BFEBBF;">(</span>&#8728; tri phasor<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">saw///</span> <span style="color: #BFEBBF;">(</span>&#8728; saw phasor<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">sampler///</span>
  <span style="color: #BFEBBF;">(</span>case-lambda
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>table frequency<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>sampler table <span style="color: #9FC59F;">(</span>phasor frequency<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>table frequency phase0<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>sampler table <span style="color: #9FC59F;">(</span>phasor frequency phase0<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/waveforms&gt;</span>
</pre>
</div>

<p>
Before we play something interesting with stuff we already defined we need
one more helper. Drawback of our way of composition of signals is that we
can't change code of one of them in live and make changed reloaded live, even
if signal is not anonymous and was defined as a top-level variable. For
signal which we plan to reload dynamically we are going to introduce wrapper
which will look for given signal's symbol on every invocation:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org0e85a28"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;live-signal&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>live-signal symbol<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>&lt;~ <span style="color: #D0BF8F;">(</span>top-level-value symbol<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/live-signal&gt;</span>
</pre>
</div>

<p>
Also useful to have live value counterpart:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org770c229"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;live-value&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>live-value symbol<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span>top-level-value symbol<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/live-value&gt;</span>
</pre>
</div>

<p>
Next step is implementation of signal arithmetics to ease their mixing and
matching.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org7385d50"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;signal-operators&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>signal-sum* x y<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>+ <span style="color: #D0BF8F;">(</span>&lt;~ x<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>&lt;~ y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">signal-sum</span> x . xs<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>fold-left signal-sum* x xs<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>signal-prod* x y<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>* <span style="color: #D0BF8F;">(</span>&lt;~ x<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>&lt;~ y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">signal-prod</span> x . xs<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>fold-left signal-prod* x xs<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">signal-diff</span> x . xs<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>y <span style="color: #9FC59F;">(</span>apply signal-sum xs<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt; <span style="color: #93E0E3;">(</span>- <span style="color: #9FC59F;">(</span>&lt;~ x<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>&lt;~ y<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">signal-div</span> x . xs<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>y <span style="color: #9FC59F;">(</span>apply signal-prod xs<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt; <span style="color: #93E0E3;">(</span>/ <span style="color: #9FC59F;">(</span>&lt;~ x<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>&lt;~ y<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>alias +~ signal-sum<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias *~ signal-prod<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias -~ signal-diff<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias /~ signal-div<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> &#8721; <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cut</span> apply signal-sum <span style="color: #7CB8BB;">&lt;...&gt;</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> &#8719; <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cut</span> apply signal-prod <span style="color: #7CB8BB;">&lt;...&gt;</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">normalizing +~</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">mix</span> . args<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>*~ <span style="color: #D0BF8F;">(</span>&#8721; args<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>constant <span style="color: #93E0E3;">(</span>inexact <span style="color: #9FC59F;">(</span>/ <span style="color: #94BFF3;">(</span>sqrt <span style="color: #E0CF9F;">(</span>length args<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>pan p<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>p <span style="color: #9FC59F;">(</span>* <span style="color: #BFEBBF;">0.5</span> <span style="color: #94BFF3;">(</span>+ <span style="color: #BFEBBF;">1.0</span> <span style="color: #E0CF9F;">(</span>&lt;~ p<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span>zero? channel<span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>- <span style="color: #BFEBBF;">1.0</span> p<span style="color: #93E0E3;">)</span>
        p<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/signal-operators&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb7833f4" class="outline-3">
<h3 id="orgb7833f4"><span class="section-number-3">5.3</span> Envelopes</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-orgffcd6c7" class="outline-4">
<h4 id="orgffcd6c7"><span class="section-number-4">5.3.1</span> ADSR</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
ADSR envelope shapes signal with polyline described with 4 parameters:
</p>

<ul class="org-ul">
<li>Attack time is the time taken for initial run-up of level from nil to peak,
beginning when the key is first pressed.</li>
<li>Decay time is the time taken for the subsequent run down from the attack
level to the designated sustain level.</li>
<li>Sustain level is the level during the main sequence of the sound's
duration, until the key is released.</li>
<li>Release time is the time taken for the level to decay from the sustain
level to zero after the key is released.</li>
</ul>

<p>
(Thanks, <a href="https://en.wikipedia.org/wiki/Synthesizer#Attack_Decay_Sustain_Release_.28ADSR.29_envelope">Wikipedia</a>)
</p>

<p>
Two more parameter required to apply envelope in real performance: note's
moments of start and end. To make envelope generic and open for crazy
experiments all 6 parameters are going to be signals:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org1018371"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;adsr&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>adsr start end attack decay sustain release<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>end <span style="color: #9FC59F;">(</span>&lt;~ end<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span>&lt;= end time<span style="color: #93E0E3;">)</span>
        <span style="color: #5F7F5F;">;; </span><span style="color: #d0bf8f;">NOTE</span><span style="color: #7F9F7F;"> OFF</span>
        <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>&#916;t <span style="color: #E0CF9F;">(</span>- time end<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
              <span style="color: #94BFF3;">[</span>r <span style="color: #E0CF9F;">(</span>&lt;~ release<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
          <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">and</span> <span style="color: #E0CF9F;">(</span>positive? r<span style="color: #E0CF9F;">)</span>
                   <span style="color: #E0CF9F;">(</span>&lt;= &#916;t r<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
              <span style="color: #94BFF3;">(</span>* <span style="color: #E0CF9F;">(</span>- <span style="color: #BFEBBF;">1.0</span> <span style="color: #8FB28F;">(</span>/ &#916;t r<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span> <span style="color: #E0CF9F;">(</span>&lt;~ sustain<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
              <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
        <span style="color: #5F7F5F;">;; </span><span style="color: #d0bf8f;">NOTE</span><span style="color: #7F9F7F;"> ON</span>
        <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>start <span style="color: #E0CF9F;">(</span>&lt;~ start<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
          <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #94BFF3;">(</span>&lt;= start time<span style="color: #94BFF3;">)</span>
              <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #E0CF9F;">(</span><span style="color: #8FB28F;">[</span>&#916;t <span style="color: #6CA0A3;">(</span>- time start<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span>
                    <span style="color: #8FB28F;">[</span>a <span style="color: #6CA0A3;">(</span>&lt;~ attack<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span><span style="color: #E0CF9F;">)</span>
                <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #8FB28F;">(</span><span style="color: #F0DFAF; font-weight: bold;">and</span> <span style="color: #6CA0A3;">(</span>positive? a<span style="color: #6CA0A3;">)</span>
                         <span style="color: #6CA0A3;">(</span>&lt;= &#916;t a<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span>
                    <span style="color: #8FB28F;">(</span>/ &#916;t a<span style="color: #8FB28F;">)</span>
                    <span style="color: #8FB28F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #6CA0A3;">(</span><span style="color: #DCDCCC;">[</span>&#916;t <span style="color: #BFEBBF;">(</span>- &#916;t a<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span>
                          <span style="color: #DCDCCC;">[</span>d <span style="color: #BFEBBF;">(</span>&lt;~ decay<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span>
                          <span style="color: #DCDCCC;">[</span>s <span style="color: #BFEBBF;">(</span>&lt;~ sustain<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span><span style="color: #6CA0A3;">)</span>
                      <span style="color: #6CA0A3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">and</span> <span style="color: #BFEBBF;">(</span>positive? d<span style="color: #BFEBBF;">)</span>
                               <span style="color: #BFEBBF;">(</span>&lt;= &#916;t d<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
                          <span style="color: #DCDCCC;">(</span>- <span style="color: #BFEBBF;">1.0</span> <span style="color: #BFEBBF;">(</span>* <span style="color: #D0BF8F;">(</span>- <span style="color: #BFEBBF;">1.0</span> s<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>/ &#916;t d<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
                          s<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
              <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/adsr&gt;</span>
</pre>
</div>

<p>
Let's test it with simple note play:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orga6b403c"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;play-note&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">simple-instrument</span> start end freq a d s r<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>start <span style="color: #9FC59F;">(</span>live-value start<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
         <span style="color: #93E0E3;">[</span>end <span style="color: #9FC59F;">(</span>live-value end<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
         <span style="color: #93E0E3;">[</span>freq <span style="color: #9FC59F;">(</span>live-value freq<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
         <span style="color: #93E0E3;">[</span>osc <span style="color: #9FC59F;">(</span>sine-wave <span style="color: #94BFF3;">(</span>phasor freq<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
         <span style="color: #93E0E3;">[</span>env <span style="color: #9FC59F;">(</span>adsr start end <span style="color: #94BFF3;">(</span>~&lt; a<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>~&lt; d<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>~&lt; s<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>~&lt; r<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>*~ env osc<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-play-note</span> start end frequency<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #D0BF8F;">(</span>freq dur<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>set-top-level-value! frequency freq<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>set-top-level-value! start <span style="color: #93E0E3;">(</span>now<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>set-top-level-value! end <span style="color: #93E0E3;">(</span>+ <span style="color: #9FC59F;">(</span>now<span style="color: #9FC59F;">)</span> dur<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define start 0.0)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define end 1.0)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define frequency 440.0)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define inst (simple-intrument 'start 'end 'frequency 0.3 0.5 0.8 1.0))</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define play-note (make-play-note 'start 'end 'frequency))</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(sound:set-dsp! (live-signal 'inst))</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(play-note 440.0 1.1)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/play-note&gt;</span>
</pre>
</div>

<p>
We return to instrument concept later and come up with better design for it.
</p>
</div>
</div>

<div id="outline-container-org27c29a9" class="outline-4">
<h4 id="org27c29a9"><span class="section-number-4">5.3.2</span> Impulse</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
Another simple though useful envelope is impulse.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org130f37a"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;impulse&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>impulse start apex<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>start <span style="color: #9FC59F;">(</span>&lt;~ start<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span>&lt;= start time<span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>h <span style="color: #E0CF9F;">(</span>/ <span style="color: #8FB28F;">(</span>- time start<span style="color: #8FB28F;">)</span>
                    <span style="color: #8FB28F;">(</span>- <span style="color: #6CA0A3;">(</span>&lt;~ apex<span style="color: #6CA0A3;">)</span> start<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
          <span style="color: #9FC59F;">(</span>* h <span style="color: #94BFF3;">(</span>exp <span style="color: #E0CF9F;">(</span>- <span style="color: #BFEBBF;">1.0</span> h<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
        <span style="color: #BFEBBF;">0.0</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/impulse&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org573eb65" class="outline-3">
<h3 id="org573eb65"><span class="section-number-3">5.4</span> Metronome</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Metronome is a mean to align scheduling with some periodic beat.
</p>
</div>
</div>

<div id="outline-container-org16aefda" class="outline-3">
<h3 id="org16aefda"><span class="section-number-3">5.5</span> Control signals</h3>
<div class="outline-text-3" id="text-5-5">
<div class="org-src-container">
<pre class="src src-scheme" id="orge00189e"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;control-signal&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*sound-barrier*</span> <span style="color: #BFEBBF;">0.03</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">linear-transition</span> &#916;t<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #D0BF8F;">(</span>&#948;t x y<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span>&lt; &#948;t &#916;t<span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>+ x <span style="color: #9FC59F;">(</span>* <span style="color: #94BFF3;">(</span>- y x<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>/ &#948;t &#916;t<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
        y<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">instant-transition</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #D0BF8F;">(</span>&#948;t x y<span style="color: #D0BF8F;">)</span>
    y<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*linear-transition*</span> <span style="color: #BFEBBF;">(</span>linear-transition *sound-barrier*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">control-signal</span>
  <span style="color: #BFEBBF;">(</span>case-lambda
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>x<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span>number? x<span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>control-signal id x *linear-transition*<span style="color: #9FC59F;">)</span>
         <span style="color: #9FC59F;">(</span>control-signal x <span style="color: #BFEBBF;">0.0</span> *linear-transition*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>f x<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span>control-signal f x *linear-transition*<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>f x transition<span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>start <span style="color: #E0CF9F;">(</span>now<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>x x<span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>y x<span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span>values
        <span style="color: #94BFF3;">(</span>~&lt; <span style="color: #E0CF9F;">(</span>transition <span style="color: #8FB28F;">(</span>- time start<span style="color: #8FB28F;">)</span> x y<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
        <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> args
          <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> x <span style="color: #8FB28F;">(</span>transition <span style="color: #6CA0A3;">(</span>- <span style="color: #DCDCCC;">(</span>now<span style="color: #DCDCCC;">)</span> start<span style="color: #6CA0A3;">)</span> x y<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span>
          <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> y <span style="color: #8FB28F;">(</span>apply f args<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span>
          <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> start <span style="color: #8FB28F;">(</span>now<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/control-signal&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org830e69a"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;beat&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">time-&gt;beat</span> time bpm<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>-&gt; time <span style="color: #D0BF8F;">(</span>* bpm<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>/ <span style="color: #BFEBBF;">60</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>round<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">beat-&gt;time</span> beat bpm<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>-&gt; beat <span style="color: #D0BF8F;">(</span>* <span style="color: #BFEBBF;">60</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>/ bpm<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">next-beat</span> time bpm<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>beat-&gt;time <span style="color: #D0BF8F;">(</span>+ <span style="color: #BFEBBF;">1</span> <span style="color: #93E0E3;">(</span>time-&gt;beat time bpm<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span> bpm<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">metro</span> bpm . args<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>apply schedule <span style="color: #D0BF8F;">(</span>next-beat <span style="color: #93E0E3;">(</span>now<span style="color: #93E0E3;">)</span> bpm<span style="color: #D0BF8F;">)</span> args<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*bpm*</span> <span style="color: #BFEBBF;">60.0</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">set-bpm!</span> bpm<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *bpm* bpm<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*beat*</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>time-&gt;beat <span style="color: #D0BF8F;">(</span>now<span style="color: #D0BF8F;">)</span> *bpm*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*metro*</span> . args<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>apply metro *bpm* args<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/beat&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7636093" class="outline-2">
<h2 id="org7636093"><span class="section-number-2">6</span> Std</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org6b2c233" class="outline-3">
<h3 id="org6b2c233"><span class="section-number-3">6.1</span> FFT</h3>
</div>
<div id="outline-container-org9734bb9" class="outline-3">
<h3 id="org9734bb9"><span class="section-number-3">6.2</span> Filters</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-scheme" id="orgdada00a"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;delay&gt;</span>
<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">delay</span> &#916;t f<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>f <span style="color: #D0BF8F;">(</span>- time <span style="color: #93E0E3;">(</span>&lt;~ &#916;t<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span> channel<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/delay&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org25c77cd"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;echo&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*max-line-duration*</span> <span style="color: #BFEBBF;">1</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">echo</span> delay feedback signal<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>line-size <span style="color: #9FC59F;">(</span>* *max-line-duration* *sample-rate*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
        <span style="color: #93E0E3;">[</span>lines <span style="color: #9FC59F;">(</span>make-vector *channels*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
        <span style="color: #93E0E3;">[</span>cursor -1<span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>i <span style="color: #BFEBBF;">0</span> <span style="color: #94BFF3;">(</span>+ i <span style="color: #BFEBBF;">1</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>= i *channels*<span style="color: #9FC59F;">)</span> <span style="color: #BFEBBF;">0</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>vector-set! lines i <span style="color: #9FC59F;">(</span>make-vector line-size <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt;
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span><span style="color: #9FC59F;">(</span>zero? channel<span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> cursor <span style="color: #94BFF3;">(</span>mod <span style="color: #E0CF9F;">(</span>+ cursor <span style="color: #BFEBBF;">1</span><span style="color: #E0CF9F;">)</span> line-size<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>line <span style="color: #E0CF9F;">(</span>vector-ref lines channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>x <span style="color: #E0CF9F;">(</span>&lt;~ signal<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>delay <span style="color: #E0CF9F;">(</span>flonum-&gt;fixnum <span style="color: #8FB28F;">(</span>round <span style="color: #6CA0A3;">(</span>* <span style="color: #DCDCCC;">(</span>&lt;~ delay<span style="color: #DCDCCC;">)</span> *sample-rate*<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>feedback <span style="color: #E0CF9F;">(</span>&lt;~ feedback<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #94BFF3;">(</span><span style="color: #E0CF9F;">[</span>i <span style="color: #8FB28F;">(</span>mod <span style="color: #6CA0A3;">(</span>+ line-size <span style="color: #DCDCCC;">(</span>- cursor delay<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span> line-size<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
              <span style="color: #E0CF9F;">[</span>y <span style="color: #8FB28F;">(</span>vector-ref line i<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
              <span style="color: #E0CF9F;">[</span>z <span style="color: #8FB28F;">(</span>+ x <span style="color: #6CA0A3;">(</span>* feedback y<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>vector-set! line cursor z<span style="color: #94BFF3;">)</span>
         z<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/echo&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org1a2067a"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;lpf&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">lpf-frequency-&gt;&#945;</span> frequency<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>k <span style="color: #9FC59F;">(</span>* frequency *sample-angular-period*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>/ k <span style="color: #93E0E3;">(</span>+ k <span style="color: #BFEBBF;">1</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">lpf</span> frequency x<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>ys <span style="color: #9FC59F;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt;
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>y-1 <span style="color: #E0CF9F;">(</span>vector-ref ys channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
            <span style="color: #94BFF3;">[</span>&#945; <span style="color: #E0CF9F;">(</span>lpf-frequency-&gt;&#945; <span style="color: #8FB28F;">(</span>&lt;~ frequency<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #94BFF3;">(</span><span style="color: #E0CF9F;">[</span>y <span style="color: #8FB28F;">(</span>+ y-1 <span style="color: #6CA0A3;">(</span>* &#945; <span style="color: #DCDCCC;">(</span>- <span style="color: #BFEBBF;">(</span>&lt;~ x<span style="color: #BFEBBF;">)</span> y-1<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>vector-set! ys channel y<span style="color: #94BFF3;">)</span>
         y<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/lpf&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org70cf9ca"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;hpf&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">hpf-frequency-&gt;&#945;</span> frequency<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>k <span style="color: #9FC59F;">(</span>* frequency *sample-angular-period*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>/ <span style="color: #93E0E3;">(</span>+ k <span style="color: #BFEBBF;">1</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">hpf</span> frequency x<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>xs <span style="color: #9FC59F;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
        <span style="color: #93E0E3;">[</span>ys <span style="color: #9FC59F;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>~&lt;
     <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">[</span>x-1 <span style="color: #E0CF9F;">(</span>vector-ref xs channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>y-1 <span style="color: #E0CF9F;">(</span>vector-ref ys channel<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>x <span style="color: #E0CF9F;">(</span>&lt;~ x<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
           <span style="color: #94BFF3;">[</span>&#945; <span style="color: #E0CF9F;">(</span>hpf-frequency-&gt;&#945; <span style="color: #8FB28F;">(</span>&lt;~ frequency<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">)</span>
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #94BFF3;">(</span><span style="color: #E0CF9F;">[</span>y <span style="color: #8FB28F;">(</span>* &#945; <span style="color: #6CA0A3;">(</span>+ y-1 <span style="color: #DCDCCC;">(</span>- x x-1<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>vector-set! xs channel x<span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span>vector-set! ys channel y<span style="color: #94BFF3;">)</span>
         y<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/hpf&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org05743c8"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;make-biquad-filter&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-biquad-filter</span> make-coefficients<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #D0BF8F;">(</span>Q frequency x<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>xs-1 <span style="color: #94BFF3;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
          <span style="color: #9FC59F;">[</span>xs-2 <span style="color: #94BFF3;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
          <span style="color: #9FC59F;">[</span>ys-1 <span style="color: #94BFF3;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
          <span style="color: #9FC59F;">[</span>ys-2 <span style="color: #94BFF3;">(</span>make-vector *channels* <span style="color: #BFEBBF;">0.0</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>~&lt;
       <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #94BFF3;">(</span><span style="color: #E0CF9F;">[</span>x-1 <span style="color: #8FB28F;">(</span>vector-ref xs-1 channel<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
             <span style="color: #E0CF9F;">[</span>x-2 <span style="color: #8FB28F;">(</span>vector-ref xs-2 channel<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
             <span style="color: #E0CF9F;">[</span>y-1 <span style="color: #8FB28F;">(</span>vector-ref ys-1 channel<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
             <span style="color: #E0CF9F;">[</span>y-2 <span style="color: #8FB28F;">(</span>vector-ref ys-2 channel<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
             <span style="color: #E0CF9F;">[</span>x <span style="color: #8FB28F;">(</span>&lt;~ x<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
             <span style="color: #E0CF9F;">[</span>Q <span style="color: #8FB28F;">(</span>&lt;~ Q<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span>
             <span style="color: #E0CF9F;">[</span>frequency <span style="color: #8FB28F;">(</span>&lt;~ frequency<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span>
         <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #E0CF9F;">(</span><span style="color: #8FB28F;">[</span>&#969; <span style="color: #6CA0A3;">(</span>* frequency *sample-angular-period*<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span>
                <span style="color: #8FB28F;">[</span>sin-&#969; <span style="color: #6CA0A3;">(</span>sin &#969;<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span>
                <span style="color: #8FB28F;">[</span>cos-&#969; <span style="color: #6CA0A3;">(</span>cos &#969;<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span>
                <span style="color: #8FB28F;">[</span>&#945; <span style="color: #6CA0A3;">(</span>/ sin-&#969; <span style="color: #DCDCCC;">(</span>* <span style="color: #BFEBBF;">2.0</span> Q<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span><span style="color: #E0CF9F;">)</span>
           <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let-values</span> <span style="color: #8FB28F;">(</span><span style="color: #6CA0A3;">[</span><span style="color: #DCDCCC;">(</span>b0 b1 b2 a0 a1 a2<span style="color: #DCDCCC;">)</span> <span style="color: #DCDCCC;">(</span>make-coefficients sin-&#969; cos-&#969; &#945;<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">]</span><span style="color: #8FB28F;">)</span>
             <span style="color: #8FB28F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #6CA0A3;">(</span><span style="color: #DCDCCC;">[</span>y <span style="color: #BFEBBF;">(</span>-
                       <span style="color: #D0BF8F;">(</span>+
                        <span style="color: #93E0E3;">(</span>* <span style="color: #9FC59F;">(</span>/ b0 a0<span style="color: #9FC59F;">)</span> x<span style="color: #93E0E3;">)</span>
                        <span style="color: #93E0E3;">(</span>* <span style="color: #9FC59F;">(</span>/ b1 a0<span style="color: #9FC59F;">)</span> x-1<span style="color: #93E0E3;">)</span>
                        <span style="color: #93E0E3;">(</span>* <span style="color: #9FC59F;">(</span>/ b2 a0<span style="color: #9FC59F;">)</span> x-2<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
                       <span style="color: #D0BF8F;">(</span>* <span style="color: #93E0E3;">(</span>/ a1 a0<span style="color: #93E0E3;">)</span> y-1<span style="color: #D0BF8F;">)</span>
                       <span style="color: #D0BF8F;">(</span>* <span style="color: #93E0E3;">(</span>/ a2 a0<span style="color: #93E0E3;">)</span> y-2<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">]</span><span style="color: #6CA0A3;">)</span>
               <span style="color: #6CA0A3;">(</span>vector-set! xs-1 channel x<span style="color: #6CA0A3;">)</span>
               <span style="color: #6CA0A3;">(</span>vector-set! xs-2 channel x-1<span style="color: #6CA0A3;">)</span>
               <span style="color: #6CA0A3;">(</span>vector-set! ys-1 channel y<span style="color: #6CA0A3;">)</span>
               <span style="color: #6CA0A3;">(</span>vector-set! ys-2 channel y-1<span style="color: #6CA0A3;">)</span>
               y<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/make-biquad-filter&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org86836d2"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;biquad-lpf&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-lpf-coefficients</span> sin-&#969; cos-&#969; &#945;<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>b0 <span style="color: #9FC59F;">(</span>* <span style="color: #BFEBBF;">0.5</span> <span style="color: #94BFF3;">(</span>- <span style="color: #BFEBBF;">1.0</span> cos-&#969;<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>values
     b0             <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">b0</span>
     <span style="color: #93E0E3;">(</span>- <span style="color: #BFEBBF;">1.0</span> cos-&#969;<span style="color: #93E0E3;">)</span>  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">b1</span>
     b0             <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">b2</span>
     <span style="color: #93E0E3;">(</span>+ <span style="color: #BFEBBF;">1.0</span> &#945;<span style="color: #93E0E3;">)</span>      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">a0</span>
     <span style="color: #93E0E3;">(</span>* -2.0 cos-&#969;<span style="color: #93E0E3;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">a1</span>
     <span style="color: #93E0E3;">(</span>- <span style="color: #BFEBBF;">1.0</span> &#945;<span style="color: #93E0E3;">)</span>      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">a2</span>
     <span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">biquad-lpf</span> <span style="color: #BFEBBF;">(</span>make-biquad-filter make-lpf-coefficients<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/biquad-lpf&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme" id="org4d8cb63"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;biquad-hpf&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-hpf-coefficients</span> sin-&#969; cos-&#969; &#945;<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>b0 <span style="color: #9FC59F;">(</span>* <span style="color: #BFEBBF;">0.5</span> <span style="color: #94BFF3;">(</span>+ <span style="color: #BFEBBF;">1.0</span> cos-&#969;<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>values
     b0             <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">b0</span>
     <span style="color: #93E0E3;">(</span>- -1.0 cos-&#969;<span style="color: #93E0E3;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">b1</span>
     b0             <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">b2</span>
     <span style="color: #93E0E3;">(</span>+ <span style="color: #BFEBBF;">1.0</span> &#945;<span style="color: #93E0E3;">)</span>      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">a0</span>
     <span style="color: #93E0E3;">(</span>* -2.0 cos-&#969;<span style="color: #93E0E3;">)</span> <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">a1</span>
     <span style="color: #93E0E3;">(</span>- <span style="color: #BFEBBF;">1.0</span> &#945;<span style="color: #93E0E3;">)</span>      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">a2</span>
     <span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">biquad-hpf</span> <span style="color: #BFEBBF;">(</span>make-biquad-filter make-hpf-coefficients<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/biquad-hpf&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c4b289" class="outline-3">
<h3 id="org3c4b289"><span class="section-number-3">6.3</span> Instruments</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">
<pre class="src src-scheme" id="org7eb331b"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;polyphony&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-polyphony</span> n make-voice<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>voices <span style="color: #9FC59F;">(</span>make-vector n &#8709;<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
        <span style="color: #93E0E3;">[</span>cursor <span style="color: #BFEBBF;">0</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>signal
           <span style="color: #94BFF3;">(</span>apply mix <span style="color: #E0CF9F;">(</span>list-ec <span style="color: #8FB28F;">(</span>: i n<span style="color: #8FB28F;">)</span> <span style="color: #8FB28F;">(</span>~&lt; <span style="color: #6CA0A3;">(</span>&lt;~ <span style="color: #DCDCCC;">(</span>vector-ref voices i<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
          <span style="color: #9FC59F;">[</span>play-note
           <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> args
             <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #8FB28F;">(</span><span style="color: #6CA0A3;">[</span>voice <span style="color: #DCDCCC;">(</span>apply make-voice args<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">]</span><span style="color: #8FB28F;">)</span>
               <span style="color: #8FB28F;">(</span>vector-set! voices cursor voice<span style="color: #8FB28F;">)</span>
               <span style="color: #8FB28F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> cursor <span style="color: #6CA0A3;">(</span>mod <span style="color: #DCDCCC;">(</span>+ cursor <span style="color: #BFEBBF;">1</span><span style="color: #DCDCCC;">)</span> n<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span>
               voice<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>values signal play-note<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-static-polyphony</span> n make-voice<span style="color: #BFEBBF;">)</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(make-voice) -&gt; (list signal play-note)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>voices <span style="color: #9FC59F;">(</span>list-ec <span style="color: #94BFF3;">(</span>: i n<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>make-voice<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
        <span style="color: #93E0E3;">[</span>cursor <span style="color: #BFEBBF;">0</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>signal <span style="color: #94BFF3;">(</span>apply mix <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">map</span> first voices<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span>
          <span style="color: #9FC59F;">[</span>play-note
           <span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> args
             <span style="color: #E0CF9F;">(</span>apply <span style="color: #8FB28F;">(</span>second <span style="color: #6CA0A3;">(</span>vector-ref voices cursor<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span> args<span style="color: #E0CF9F;">)</span>
             <span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> cursor <span style="color: #8FB28F;">(</span>mod <span style="color: #6CA0A3;">(</span>+ cursor <span style="color: #BFEBBF;">1</span><span style="color: #6CA0A3;">)</span> n<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>values signal play-note<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/polyphony&gt;</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org87366ff" class="outline-3">
<h3 id="org87366ff"><span class="section-number-3">6.4</span> Scales</h3>
<div class="outline-text-3" id="text-6-4">
<p>
We are going to represent scales with Scheme's basic data structure, list.
And the most basic operation which we want to perform on scale is chosing a
note from it without worrying about falling out of range:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orga9b34c6"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;choice&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">choice</span> list n<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>list-ref list <span style="color: #D0BF8F;">(</span>mod n <span style="color: #93E0E3;">(</span>length list<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">random-choice</span> list<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>list-ref list <span style="color: #D0BF8F;">(</span>random <span style="color: #93E0E3;">(</span>length list<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/choice&gt;</span>
</pre>
</div>

<p>
Basic intervals from Western music.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orga8747de"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;intervals&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">chromatic-scale-half-step</span>
  <span style="color: #BFEBBF;">(</span>expt <span style="color: #BFEBBF;">2</span> <span style="color: #BFEBBF;">1/12</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">second-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">2</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">third-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">4</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">perfect-fourth-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">5</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">perfect-fifth-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">7</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">major-sixth-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">9</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">major-seventh-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">11</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">perfect-octave-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">12</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">minor-second-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">1</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">minor-third-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">3</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">minor-sixth-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">8</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">minor-seventh-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">11</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">triton-interval</span> <span style="color: #BFEBBF;">(</span>expt chromatic-scale-half-step <span style="color: #BFEBBF;">11</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/intervals&gt;</span>
</pre>
</div>

<p>
Some basic scales from Western music.
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orgdee12c2"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;scales&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">chromatic-scale</span> '<span style="color: #BFEBBF;">(</span><span style="color: #BFEBBF;">1</span> <span style="color: #BFEBBF;">2</span> <span style="color: #BFEBBF;">3</span> <span style="color: #BFEBBF;">4</span> <span style="color: #BFEBBF;">5</span> <span style="color: #BFEBBF;">6</span> <span style="color: #BFEBBF;">7</span> <span style="color: #BFEBBF;">8</span> <span style="color: #BFEBBF;">9</span> <span style="color: #BFEBBF;">10</span> <span style="color: #BFEBBF;">11</span> <span style="color: #BFEBBF;">12</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pentatonic-scale</span> '<span style="color: #BFEBBF;">(</span><span style="color: #BFEBBF;">1</span> <span style="color: #BFEBBF;">3</span> <span style="color: #BFEBBF;">5</span> <span style="color: #BFEBBF;">8</span> <span style="color: #BFEBBF;">10</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">major-scale</span> '<span style="color: #BFEBBF;">(</span><span style="color: #BFEBBF;">1</span> <span style="color: #BFEBBF;">3</span> <span style="color: #BFEBBF;">5</span> <span style="color: #BFEBBF;">6</span> <span style="color: #BFEBBF;">8</span> <span style="color: #BFEBBF;">10</span> <span style="color: #BFEBBF;">12</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">minor-scale</span> '<span style="color: #BFEBBF;">(</span><span style="color: #BFEBBF;">1</span> <span style="color: #BFEBBF;">3</span> <span style="color: #BFEBBF;">4</span> <span style="color: #BFEBBF;">6</span> <span style="color: #BFEBBF;">8</span> <span style="color: #BFEBBF;">9</span> <span style="color: #BFEBBF;">11</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-scale</span> base-frequency scale<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">map</span> <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #93E0E3;">(</span>x<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>* base-frequency <span style="color: #9FC59F;">(</span>expt chromatic-scale-half-step <span style="color: #94BFF3;">(</span>- x <span style="color: #BFEBBF;">1</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span> scale<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/scales&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9d4270" class="outline-3">
<h3 id="orgd9d4270"><span class="section-number-3">6.5</span> Rhythm</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">
<pre class="src src-scheme" id="orgcb78b3d"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;pattern&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">play-pattern</span> pattern sound beat<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>n <span style="color: #9FC59F;">(</span>length pattern<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #93E0E3;">(</span>positive? <span style="color: #9FC59F;">(</span>choice pattern <span style="color: #94BFF3;">(</span>exact beat<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>sound<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/pattern&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde7f77a" class="outline-3">
<h3 id="orgde7f77a"><span class="section-number-3">6.6</span> MIDI</h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">
<pre class="src src-scheme" id="org3ea251f"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;midi&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*on-note-on*</span> timestamp data1 data2 channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>printf <span style="color: #CC9393;">"~s:~s:~s:~s\r\n"</span> timestamp data1 data2 channel<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*on-note-off*</span> timestamp data1 data2 channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>printf <span style="color: #CC9393;">"~s:~s:~s:~s\r\n"</span> timestamp data1 data2 channel<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">*on-cc*</span> timestamp data1 data2 channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>printf <span style="color: #CC9393;">"~s:~s:~s:~s\r\n"</span> timestamp data1 data2 channel<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">set-note-on!</span> f<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *on-note-on* f<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">set-note-off!</span> f<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *on-note-off* f<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">set-cc!</span> f<span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *on-cc* f<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*polling-cycle*</span> <span style="color: #BFEBBF;">0.005</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*stream*</span> #f<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">*scheduler*</span> #f<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">process-event</span> timestamp type data1 data2 channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= type pm:*midi-note-on*<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>*on-note-on* timestamp data1 data2 channel<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= type pm:*midi-note-off*<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>*on-note-off* timestamp data1 data2 channel<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #93E0E3;">(</span>= type pm:*midi-cc*<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>*on-cc* timestamp data1 data2 channel<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span>
    <span style="color: #D0BF8F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #93E0E3;">(</span>printf <span style="color: #CC9393;">"Unsupported event type: ~s\r\n"</span> type<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">]</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-safe-process-event</span> timestamp<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> args
    <span style="color: #D0BF8F;">(</span>guard <span style="color: #93E0E3;">(</span>_ <span style="color: #9FC59F;">[</span><span style="color: #F0DFAF; font-weight: bold;">else</span> #f<span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>apply process-event timestamp args<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">process-events</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>timestamp <span style="color: #9FC59F;">(</span>scheduler:now *scheduler*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #93E0E3;">(</span>pm:poll *stream*<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>pm:read *stream* <span style="color: #9FC59F;">(</span>make-safe-process-event timestamp<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>scheduler:schedule *scheduler*
                        <span style="color: #93E0E3;">(</span>+ timestamp *polling-cycle*<span style="color: #93E0E3;">)</span>
                        process-events<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">start</span> now<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">unless</span> *stream*
    <span style="color: #D0BF8F;">(</span>pm:init<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *stream* <span style="color: #93E0E3;">(</span>pm:open-input <span style="color: #BFEBBF;">0</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *scheduler* <span style="color: #93E0E3;">(</span>scheduler:simple-scheduler now<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>scheduler:start-scheduler *scheduler*<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>process-events<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">stop</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> *stream*
    <span style="color: #D0BF8F;">(</span>scheduler:stop-scheduler *scheduler*<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>pm:close *stream*<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>pm:terminate<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *stream* #f<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">set!</span> *scheduler* #f<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/midi&gt;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge215653" class="outline-2">
<h2 id="orge215653"><span class="section-number-2">7</span> Misc</h2>
<div class="outline-text-2" id="text-7">
<p>
To import <code>chez-soundio</code> and <code>chez-sockets</code> we must add respective folders to
<code>library-directories</code> To do that let's create a couple of helpers:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="orga83b4ac"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;add-library-directories&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">add-library-directory</span> dir<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>library-directories
   <span style="color: #D0BF8F;">(</span>cons dir <span style="color: #93E0E3;">(</span>library-directories<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">add-library-directories</span> . dirs<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">unless</span> <span style="color: #D0BF8F;">(</span>null? dirs<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>add-library-directory <span style="color: #93E0E3;">(</span>car dirs<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>apply add-library-directories <span style="color: #93E0E3;">(</span>cdr dirs<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>add-library-directories
 <span style="color: #CC9393;">"./chez-soundio"</span>
 <span style="color: #CC9393;">"./chez-portmidi"</span>
 <span style="color: #CC9393;">"./chez-sockets"</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/add-library-directories&gt;</span>
</pre>
</div>

<p>
Also let's define several useful aliases and finally start our services:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org6527a67"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;ad-libitum-init&gt;</span>
<span style="color: #DCDCCC;">(</span>alias now sound:now<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias schedule scheduler:*schedule*<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>alias callback schedule<span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">in case of emergency &#9786;</span>
<span style="color: #DCDCCC;">(</span>alias h! sound:hush!<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>alias play! sound:set-dsp!<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>sound:start<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>scheduler:init now<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>scheduler:start<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC;">(</span>repl:start-repl-server<span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/ad-libitum-init&gt;</span>
</pre>
</div>

<p>
Tuner stuff to test everything is working:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org435b0d9"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;test-tuner&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">tuner</span> time channel<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>sin <span style="color: #D0BF8F;">(</span>* <span style="color: #BFEBBF;">2&#960;</span> time tuner-frequency<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(sound:set-dsp! tuner)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/test-tuner&gt;</span>
</pre>
</div>

<p>
Some stuff about time and scales to be moved to appropriate sections when
we'll come to them:
</p>

<div class="org-src-container">
<pre class="src src-scheme" id="org30ab593"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;sandbox&gt;</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">unroll</span> signal period<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>n <span style="color: #9FC59F;">(</span>exact <span style="color: #94BFF3;">(</span>truncate <span style="color: #E0CF9F;">(</span>* period *sample-rate*<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
         <span style="color: #93E0E3;">[</span>table <span style="color: #9FC59F;">(</span>make-vector n<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">do</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">[</span>i <span style="color: #BFEBBF;">0</span> <span style="color: #94BFF3;">(</span>+ i <span style="color: #BFEBBF;">1</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">]</span><span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>= i n<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>vector-set! table i <span style="color: #9FC59F;">(</span>inexact <span style="color: #94BFF3;">(</span>signal <span style="color: #E0CF9F;">(</span>/ i *sample-rate*<span style="color: #E0CF9F;">)</span> <span style="color: #BFEBBF;">0</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">cut</span> sampler table &lt;&gt;<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">make-overtone</span> amplitudes wave frequency phase0<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>&#8721; <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">map</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">&#955;</span> <span style="color: #9FC59F;">(</span>amplitude factor<span style="color: #9FC59F;">)</span>
        <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #94BFF3;">(</span><span style="color: #E0CF9F;">[</span>factor <span style="color: #8FB28F;">(</span>inexact factor<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">]</span><span style="color: #94BFF3;">)</span>
          <span style="color: #94BFF3;">(</span>*~ amplitude
              <span style="color: #E0CF9F;">(</span>wave <span style="color: #8FB28F;">(</span>osc:phasor <span style="color: #6CA0A3;">(</span>*~ <span style="color: #DCDCCC;">(</span>~&lt; factor<span style="color: #DCDCCC;">)</span> frequency<span style="color: #6CA0A3;">)</span> phase0<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      amplitudes
      <span style="color: #93E0E3;">(</span>iota <span style="color: #9FC59F;">(</span>length amplitudes<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #BFEBBF;">(</span><span style="color: #93E0E3;">fix-duration</span> duration<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">[</span>start <span style="color: #9FC59F;">(</span>now<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span>
         <span style="color: #93E0E3;">[</span>end <span style="color: #9FC59F;">(</span>+ start duration<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">]</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>values <span style="color: #93E0E3;">(</span>~&lt; start<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>~&lt; end<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span>define~ <span style="color: #BFEBBF;">(</span>amplitude-&gt;phase s<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>* <span style="color: #BFEBBF;">0.5</span> <span style="color: #D0BF8F;">(</span>+ <span style="color: #BFEBBF;">1.0</span> <span style="color: #93E0E3;">(</span>&lt;~ s<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;/sandbox&gt;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ruslan Prakapchuk</p>
<p class="date">Created: 2017-10-14 Sat 13:27</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
