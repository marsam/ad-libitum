<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>The Theory and Technique of Electronic Music Exercises in Ad Libitum</title>
<!-- 2017-10-25 Wed 19:34 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Ruslan Prakapchuk" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">The Theory and Technique of Electronic Music Exercises in Ad Libitum</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Sinusoids, amplitude and frequency</a>
<ul>
<li><a href="#sec-1-1">1.1. Measures of Amplitude</a></li>
<li><a href="#sec-1-2">1.2. Units of Amplitude</a></li>
<li><a href="#sec-1-3">1.3. Controlling Amplitude</a></li>
<li><a href="#sec-1-4">1.4. Frequency</a></li>
<li><a href="#sec-1-5">1.5. Synthesizing a sinusoid</a></li>
<li><a href="#sec-1-6">1.6. Superposing Signals</a></li>
<li><a href="#sec-1-7">1.7. Periodic Signals</a></li>
<li><a href="#sec-1-8">1.8. About the Software Examples</a></li>
<li><a href="#sec-1-9">1.9. Examples</a>
<ul>
<li><a href="#sec-1-9-1">1.9.1. Constant amplitude scaler</a></li>
<li><a href="#sec-1-9-2">1.9.2. Amplitude control in decibels</a></li>
<li><a href="#sec-1-9-3">1.9.3. Smoothed envelope control with an envelope generator</a></li>
<li><a href="#sec-1-9-4">1.9.4. Major triad</a></li>
<li><a href="#sec-1-9-5">1.9.5. Conversion between frequency and pitch</a></li>
<li><a href="#sec-1-9-6">1.9.6. More additive synthesis</a></li>
</ul>
</li>
<li><a href="#sec-1-10">1.10. Exercises</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Wavetables and samplers</a>
<ul>
<li><a href="#sec-2-1">2.1. The Wavetable Oscillator</a></li>
<li><a href="#sec-2-2">2.2. Sampling</a></li>
<li><a href="#sec-2-3">2.3. Enveloping samplers</a></li>
<li><a href="#sec-2-4">2.4. Timbre stretching</a></li>
<li><a href="#sec-2-5">2.5. Interpolation</a></li>
<li><a href="#sec-2-6">2.6. Examples</a></li>
<li><a href="#sec-2-7">2.7. Exercises</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
It's my exercise book for studying "The Theory and Technique of Electronic
Music" by Miller Puckette. Work is done in Ad Libitum instead of PureData, and
some pieces of code migrate back to Ad Libitum standard library.
</p>

<p>
You might want to read this file here <a href="http://ul.mantike.pro/ad-libitum/TTEM.html">http://ul.mantike.pro/ad-libitum/TTEM.html</a>
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Sinusoids, amplitude and frequency</h2>
<div class="outline-text-2" id="text-1">
<p>
Ad Libitum deals with continous representation of time, it's expressed as a
float number of seconds passed from the stream start. For any signal either
continous or discrete feels more natural, and there is no clear measure of
their shares. Good news that conversion is relatively easy in both directions.
</p>

<p>
<code>~&lt;</code> is a syntax sugar which wraps code into function of two parameters:
<code>time</code> and <code>channel</code>, which are thrown in scope. Such kind of function is how
Ad Libitum represents audio signals. Think about time as a continuous
counterpart of sample number <code>n</code> in TTEM. <code>channel</code> will be discussed later.
Think about <code>~&lt;</code> as the thing which animates your formula to produce signal.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">sinusoid</span> a &#969; &#966;) (~&lt; (* a (cos (+ (* &#969; time) &#966;)))))
</pre>
</div>

<p>
<code>play!</code> connects your signal to audio output and you can hear it! Amplitude
range in Ad Libitum is [-1, 1], setting a=0.2 we are producing signal in 1/5
of it.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play! (sinusoid 0.2 2000.0 0.0))
</pre>
</div>

<p>
And the most important function in Ad Libitum — <code>h!</code> hush!
</p>

<div class="org-src-container">

<pre class="src src-scheme">(h!)
</pre>
</div>

<p>
Let's make sinusoid to receive regular frequency instead of angular one.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">&#402;</span>&#8594;&#969; &#402;)
  (* 2&#960; &#402;))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">&#969;</span>&#8594;&#402; &#969;)
  (/ &#969; 2&#960;))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">sinusoid</span> a &#402; &#966;)
  (~&lt; (* a (cos (+ (* (&#402;&#8594;&#969; &#402;) time) &#966;)))))

(play! (sinusoid 0.2 440.0 0.0))
(h!)
</pre>
</div>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Measures of Amplitude</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This is not a blood pact, but many of Ad Libitum code relies on fact that
audiosignal is called sample by sample, without skips. Making that assumption
we are able to write RMS amplitude measurement even in continuous
representation of time.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">rms-amplitude</span> window-width s)
  (<span style="font-weight: bold;">let</span> ([windows (make-vector *channels*)]
        [N (-&gt; window-width (* *sample-rate*) (ceiling) (exact))]
        [cursor -1])
    (do-ec (: i *channels*)
           (vector-set! windows i (make-vector N 0.0)))
    (~&lt;
     (when (zero? channel)
       (set! cursor (mod (+ cursor 1) N)))
     (<span style="font-weight: bold;">let</span> ([window (vector-ref windows channel)]
           [x 0.0])
       (vector-set! window cursor (&lt;~ s))
       (vector-for-each (<span style="font-weight: bold;">&#955;</span> (y) (set! x (+ x (* y y)))) window)
       (sqrt (/ x N))))))
</pre>
</div>

<p>
Let's make sinusoid amplitude a signal, and set it to rms amplitude measured
from sinusoid with peak amplitude 1.0
Note <code>&lt;~</code> syntax sugar to apply audiosignal function to time and channel.
<code>(&lt;~ a)</code> is equivalent to <code>(a time channel)</code>
Also note how we make constant signal with <code>(~&lt; 1.0)</code>
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">sinusoid</span> a &#402; &#966;)
  (~&lt; (* (&lt;~ a) (cos (+ (* (&#402;&#8594;&#969; &#402;) time) &#966;)))))
</pre>
</div>

<p>
Note that computing rms in realtime is very expensive.
Try to increase window width until you get audio buffer underflow glitches.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play! (sinusoid (rms-amplitude 2/440 (sinusoid (~&lt; 1.0) 440.0 0.0)) 440.0 0.0))
(h!)
</pre>
</div>

<p>
Compare with 1.0 peak itself, it's louder!
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play! (sinusoid (~&lt; 1.0) 440.0 0.0))
(h!)
</pre>
</div>

<p>
Let's throttle <code>rms-amplitude</code> to make it less hungry
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">rms-amplitude</span> window-width s)
  (<span style="font-weight: bold;">let</span> ([windows (make-vector *channels*)]
        [N (-&gt; window-width (* *sample-rate*) (ceiling) (exact))]
        [cursor -1]
        [amplitudes (make-vector *channels* 0.0)])
    (do-ec (: i *channels*)
           (vector-set! windows i (make-vector N 0.0)))
    (~&lt;
     (when (zero? channel)
       (set! cursor (mod (+ cursor 1) N)))
     (<span style="font-weight: bold;">let</span> ([window (vector-ref windows channel)])
       (vector-set! window cursor (&lt;~ s))
       (when (zero? cursor)
         (vector-set!
          amplitudes
          channel
          (<span style="font-weight: bold;">let</span> ([x 0.0])
            (vector-for-each (<span style="font-weight: bold;">&#955;</span> (y) (set! x (+ x (* y y)))) window)
            (sqrt (/ x N))))))
     (vector-ref amplitudes channel))))

(play! (sinusoid (rms-amplitude 1 (+~ (sinusoid (~&lt; 1.0) 440.0 0.0))) 440.0 0.0))
(h!)
</pre>
</div>

<p>
Chez Scheme GC is so cool that though we produce a lot of garbage every
second it doesn't interrupt sound! But we still have a noticeable lag on
window initialization. Take it into account if you are going to spawn
capacitive <code>rms-amplitude</code> signals frequently.
</p>

<p>
In future for sinusoid we will use built-in Ad Libitum oscillator available
as <code>osc:sine</code> (takes phasor signal as input, we'll cover it later) and
<code>osc:sine///</code> (takes frequency and optional initial phase).
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play! (osc:sine (osc:phasor 440.0 0.0)))
(play! (osc:sine/// 440.0 0.0))
(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Units of Amplitude</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Convert amplitude to decibels, with a0 = 1e-5 as suggested in TTEM
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">amp-&gt;dB</span> x)
  (* 20.0 (log (* x 1e5) 10.0)))

(amp-&gt;dB 1.0)
(amp-&gt;dB 0.5)
</pre>
</div>

<p>
But setting a0 to 1.0 is also very convenient — maximum amplitude is then 0dB
and any one below is just negative. All relations stays the same.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">amp-&gt;dB</span> x)
  (* 20.0 (log x 10.0)))

(amp-&gt;dB 0.5)
(amp-&gt;dB 1e-5)
</pre>
</div>

<p>
And convert decibels back to amplitude:
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">dB-&gt;amp</span> x)
  (expt 10.0 (/ x 20.0)))

(dB-&gt;amp -100.0)
(dB-&gt;amp -50.0)
(dB-&gt;amp -10.0)
(dB-&gt;amp 0.0)
</pre>
</div>

<p>
Amplitude is related in an inexact way to the perceived loudness of a sound.
In general, two signals with the same peak or RMS amplitude won’t necessarily
have the same loudness at all. But amplifying a signal by 3 dB, say, will
fairly reliably make it sound about one “step” louder.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">*volume-step-dB*</span> 3.0)
</pre>
</div>

<p>
Let's test it!
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">sinusoid</span> a &#402; &#966;)
  (~&lt; (* a (cos (+ (* (&#402;&#8594;&#969; &#402;) time) &#966;)))))
(play! (sinusoid (dB-&gt;amp -10.0) 440.0 0.0))
(play! (sinusoid (dB-&gt;amp (- 10.0 *volume-step-dB*)) 440.0 0.0))
(h!)
</pre>
</div>

<p>
Try to change step. For that wave personally I hear 2dB difference.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Controlling Amplitude</h3>
<div class="outline-text-3" id="text-1-3">
<p>
We already controlled amplitude by multiplying every sample by <code>a</code>
Let's do it by multiplying sinusoid by constant signal.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play! (*~ (~&lt; 0.5) (osc:sine/// 440.0)))
(play! (*~ (~&lt; 0.2) (osc:sine/// 440.0)))
(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Frequency</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">midi-pitch-&gt;frequency</span> m)
  (* 440.0 (expt 2.0 (/ (- m 69.0) 12.0))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">frequency-&gt;midi-pitch</span> f)
  (+ 69 (exact (round (* 12.0 (log (/ f 440.0) 2.0))))))

(play! (osc:sine/// (midi-pitch-&gt;frequency 69)))
(play! (osc:sine/// (midi-pitch-&gt;frequency 72)))
(h!)
</pre>
</div>

<p>
Ad Libitum allows you to use MIDI controller. Support is still incomplete and
relies on many assumptions. Your MIDI input device should be connected and
identified as the first one.
<code>now</code> is Ad Libitum clock function. It's required for MIDI module to put
proper timestamps on events.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(midi:start now)
</pre>
</div>

<p>
Let's defined so called control signal for our frequency. We'll speak about
control signals later, but putting it simply, control signal is an audio
signal which is updated in non-audio rate by calling its setter.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(define-values (frequency set-frequency!) (ctrl:make-control 440.0))
</pre>
</div>

<p>
Let's set callback which will be called for every control change MIDI event.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(midi:set-cc! (<span style="font-weight: bold;">&#955;</span> (t knob value channel)
                (set-frequency! (midi-pitch-&gt;frequency value))))

(play! (osc:sine/// frequency))
(h!)
</pre>
</div>

<p>
Notice that abrupt change of frequency cause "pops" discussed in TTEM 1.5
</p>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Synthesizing a sinusoid</h3>
<div class="outline-text-3" id="text-1-5">
<p>
To make transition smooth we could use built-in <code>env:linear-transition</code>
</p>

<div class="org-src-container">

<pre class="src src-scheme">(define-values (frequency set-frequency!) (ctrl:make-control 440.0))

(play! (osc:sine/// (env:linear-transition (~&lt; 0.05) frequency)))
(h!)
</pre>
</div>

<p>
Besides of using MIDI input we could make frequency change programmatically.
<code>schedule</code> allows you to call any function later at given point of time.
Any function could schedule itself. It is called temporal recursion.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">swap-frequency</span> i)
  (<span style="font-weight: bold;">if</span> (zero? i)
      (set-frequency! 440.0)
      (set-frequency! 220.0))
  (schedule (+ (now) 1/4) 'swap-frequency (- 1 i)))

(swap-frequency 0)

(play! (osc:sine/// frequency))
(play! (osc:sine/// (env:linear-transition (~&lt; 0.05) frequency)))
(play! (osc:sine/// (env:quadratic-transition (~&lt; 0.05) frequency)))
(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> Superposing Signals</h3>
<div class="outline-text-3" id="text-1-6">
<p>
To superpose signals in Ad Libitum signal sum operator <code>+~</code> is available.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play! (+~ (*~ (~&lt; 0.5) (osc:sine/// (midi-pitch-&gt;frequency 69)))
           (*~ (~&lt; 0.5) (osc:sine/// (midi-pitch-&gt;frequency 72)))))
(h!)
</pre>
</div>

<p>
Let's measure how peak and rms amplitude of sinusoids superposition relates
to sum of their amplitudes.
</p>

<p>
For that we need to define <code>peak-amplitude</code> signal.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">peak-amplitude</span> signal)
  (<span style="font-weight: bold;">let</span> ([peaks (make-vector *channels* 0.0)])
    (~&lt;
     (<span style="font-weight: bold;">let*</span> ([sample (&lt;~ signal)]
            [peak (max sample (vector-ref peaks channel))])
       (vector-set! peaks channel peak)
       peak))))
</pre>
</div>

<p>
Because Ad Libitum signals are kind of pull FRP, we can't just wrap our
signal with <code>rms-amplitude</code> and then play initial signal and have RMS one
updated. Let's define useful signal which keep signals given to it updated,
but plays only first one.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">solo</span> audio . muted)
  (~&lt;
   (<span style="font-weight: bold;">for-each</span> (cut &lt;&gt; time channel) muted)
   (&lt;~ audio)))
</pre>
</div>

<p>
Uncorrelated signals.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-1</span> (*~ (~&lt; 0.5) (osc:sine/// (midi-pitch-&gt;frequency 69))))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-2</span> (*~ (~&lt; 0.5) (osc:sine/// (midi-pitch-&gt;frequency 72))))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">superposed-signal</span> (+~ signal-1 signal-2))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">signal-1 and signal-2 peaks are obviously 0.5</span>
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">measure-peak</span> (peak-amplitude superposed-signal))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">measure-rms-signal-1-2</span> (rms-amplitude 0.1 signal-1))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">measure-rms</span> (rms-amplitude 0.1 superposed-signal))

(play! (solo superposed-signal measure-peak measure-rms measure-rms-signal-1-2))
(h!)

(measure-peak 0.0 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; 0.9999931184993082</span>
(measure-rms 0.0 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; 0.5038381755150125</span>
(measure-rms-signal-1-2 0.0 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; 0.3535533905956031</span>
</pre>
</div>

<p>
Correlated signals.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-1</span> (*~ (~&lt; 0.5) (osc:sine/// 440.0)))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-2</span> (*~ (~&lt; 0.5) (osc:sine/// 440.0)))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">superposed-signal</span> (+~ signal-1 signal-2))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">signal-1 and signal-2 peaks are obviously 0.5</span>
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">measure-peak</span> (peak-amplitude superposed-signal))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">measure-rms-signal-1-2</span> (rms-amplitude 0.1 signal-1))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">measure-rms</span> (rms-amplitude 0.1 superposed-signal))

(play! (solo superposed-signal measure-peak measure-rms measure-rms-signal-1-2))
(h!)

(measure-peak 0.0 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; 1.0</span>
(measure-rms 0.0 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; 0.7071067811829478</span>
(measure-rms-signal-1-2 0.0 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; 0.3535533905914739</span>
</pre>
</div>

<p>
To be honest, trick with <code>solo</code> points to drawbacks in <code>rms-amplitude</code> and
<code>peak-amplitude</code> design. It would be better for them to just proxy input
signal and provide some accessor to measurement result.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">peak-amplitude</span> signal)
  (<span style="font-weight: bold;">let</span> ([peaks (make-vector *channels* 0.0)])
    (values
     (~&lt;
      (<span style="font-weight: bold;">let*</span> ([sample (&lt;~ signal)]
             [peak (max sample (vector-ref peaks channel))])
        (vector-set! peaks channel peak)
        sample))
     (<span style="font-weight: bold;">&#955;</span> () peaks))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">window</span> width signal)
  (<span style="font-weight: bold;">let</span> ([windows (make-vector *channels*)]
        [N (-&gt; width (* *sample-rate*) (ceiling) (exact))]
        [cursor -1])
    (do-ec (: i *channels*)
           (vector-set! windows i (make-vector N 0.0)))
    (values
     (~&lt;
      (when (zero? channel)
        (set! cursor (mod (+ cursor 1) N)))
      (<span style="font-weight: bold;">let</span> ([sample (&lt;~ signal)]
            [window (vector-ref windows channel)])
        (vector-set! window cursor sample)
        sample))
     (<span style="font-weight: bold;">&#955;</span> () windows))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">rms-amplitude</span> window-width signal)
  (<span style="font-weight: bold;">let-values</span> ([(signal windows) (window window-width signal)])
    (values
     signal
     (<span style="font-weight: bold;">&#955;</span> ()
       (vector-map
        (<span style="font-weight: bold;">&#955;</span> (window)
          (<span style="font-weight: bold;">let</span> ([x 0.0])
            (vector-for-each (<span style="font-weight: bold;">&#955;</span> (y) (set! x (+ x (* y y)))) window)
            (sqrt (/ x (vector-length window)))) )
        (windows))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-1</span> (*~ (~&lt; 0.5) (osc:sine/// (midi-pitch-&gt;frequency 69))))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-2</span> (*~ (~&lt; 0.5) (osc:sine/// (midi-pitch-&gt;frequency 72))))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">superposed-signal</span> (+~ signal-1 signal-2))

(define-values (superposed-signal measure-peak) (peak-amplitude superposed-signal))
(define-values (superposed-signal measure-rms) (rms-amplitude 0.1 superposed-signal))

(play! superposed-signal)
(h!)

(measure-peak)
(measure-rms)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> Periodic Signals</h3>
<div class="outline-text-3" id="text-1-7">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s1</span> (*~ (~&lt; 0.5) (osc:sine/// 220.0 0.0)))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s2</span> (*~ (~&lt; 0.3) (osc:sine/// 440.0 0.1)))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s3</span> (*~ (~&lt; 0.2) (osc:sine/// 660.0 0.2)))

(play! (+~ s1 s2 s3))

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> About the Software Examples</h3>
<div class="outline-text-3" id="text-1-8">
<p>
Oh, well&#x2026; You are already running Ad Libitum at this point.
</p>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9"><span class="section-number-3">1.9</span> Examples</h3>
<div class="outline-text-3" id="text-1-9">
</div><div id="outline-container-sec-1-9-1" class="outline-4">
<h4 id="sec-1-9-1"><span class="section-number-4">1.9.1</span> Constant amplitude scaler</h4>
<div class="outline-text-4" id="text-1-9-1">
<p>
Note how Pd boxes corresponds to Ad Libitum expressions in parenthesis, and
instead of graph-like connections tree structure is used. Don't judge fast
it as limiting, you always can reuse expression by naming it with help of
<code>define</code> or <code>let</code>, and we will show later how powerful is textual
representation.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play!
 (*~
  (~&lt; 0.05)
  (osc:sine/// 440.0)))

(h!)

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">or</span>

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid</span> (osc:sine/// 440.0))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">amplitude</span> (~&lt; 0.05))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">scaled-sinusoid</span> (*~ amplitude sinusoid))

(play! scaled-sinusoid)

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-9-2" class="outline-4">
<h4 id="sec-1-9-2"><span class="section-number-4">1.9.2</span> Amplitude control in decibels</h4>
<div class="outline-text-4" id="text-1-9-2">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">amplitude</span> 0.0)
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">amplitude~</span> (live-value 'amplitude))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">set-amplitude!</span> dB)
  (set! amplitude (dB-&gt;amp dB)))

(play! (*~ amplitude~ (osc:sine/// 440.0)))

(set-amplitude! 0) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">beware of loud sound</span>
(set-amplitude! -10)
(set-amplitude! -20)
(set-amplitude! -50)

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-9-3" class="outline-4">
<h4 id="sec-1-9-3"><span class="section-number-4">1.9.3</span> Smoothed envelope control with an envelope generator</h4>
<div class="outline-text-4" id="text-1-9-3">
<p>
Note, that in <b>𝔄𝔏</b> instead of messages we just set values or invoke function
which do that.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">make-line</span>)
  (<span style="font-weight: bold;">let-values</span> ([(value set-value!) (ctrl:make-control 0.0)]
               [(&#916;t set-&#916;t!) (ctrl:make-control 0.0)])
    (values
     (env:linear-transition &#916;t value)
     set-value!
     set-&#916;t!)))

(define-values (line~ set-amplitude! set-&#916;t!) (make-line))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">slow-on</span>)
  (set-&#916;t! 2.0)
  (set-amplitude! 0.1))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">fast-on</span>)
  (set-&#916;t! 0.05)
  (set-amplitude! 0.1))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">instant-on</span>)
  (set-&#916;t! 0.0)
  (set-amplitude! 0.1))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">slow-off</span>)
  (set-&#916;t! 2.0)
  (set-amplitude! 0.0))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">fast-off</span>)
  (set-&#916;t! 0.05)
  (set-amplitude! 0.0))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">instant-off</span>)
  (set-&#916;t! 0.0)
  (set-amplitude! 0.0))

(play! (*~ (osc:sine/// 440.0) line~))

(slow-on)
(slow-off)

(fast-on)
(fast-off)

(instant-on)
(instant-off)

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-9-4" class="outline-4">
<h4 id="sec-1-9-4"><span class="section-number-4">1.9.4</span> Major triad</h4>
<div class="outline-text-4" id="text-1-9-4">
<p>
<code>mix</code> is normalizing <code>+~</code>
</p>

<div class="org-src-container">

<pre class="src src-scheme">(play!
 (mix (osc:sine/// 440.0)
      (osc:sine/// 550.0)
      (osc:sine/// 660.0)))

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-9-5" class="outline-4">
<h4 id="sec-1-9-5"><span class="section-number-4">1.9.5</span> Conversion between frequency and pitch</h4>
<div class="outline-text-4" id="text-1-9-5">
<p>
This is covered well before. Only worth to note once more that in <b>𝔄𝔏</b>
instead of message passing we just give names, set values and call functions.
</p>
</div>
</div>

<div id="outline-container-sec-1-9-6" class="outline-4">
<h4 id="sec-1-9-6"><span class="section-number-4">1.9.6</span> More additive synthesis</h4>
<div class="outline-text-4" id="text-1-9-6">
<div class="org-src-container">

<pre class="src src-scheme">(define-values
  (frequency set-pitch!)
  (ctrl:make-control midi-pitch-&gt;frequency 0.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s1</span> (osc:sine/// frequency))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s2</span> (*~ (~&lt; 0.1) (osc:sine/// (*~ (~&lt; 2.0) frequency))))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s3</span> (*~ (~&lt; 0.2) (osc:sine/// (*~ (~&lt; 3.0) frequency))))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s4</span> (*~ (~&lt; 0.5) (osc:sine/// (*~ (~&lt; 4.0) frequency))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">switch</span>)
  (<span style="font-weight: bold;">let</span> ([value 0.0])
    (values
     (~&lt; value)
     (<span style="font-weight: bold;">&#955;</span> () (set! value (- 1.0 value))))))

(define-values (overtones-switch toggle-overtones!) (switch))

(play! (+~ s1
           (*~ overtones-switch
               (+~ s2 s3 s4))))

(set-pitch! 69)
(toggle-overtones!)

(set-pitch! 50)
(toggle-overtones!)

(h!)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10"><span class="section-number-3">1.10</span> Exercises</h3>
<div class="outline-text-3" id="text-1-10">
<div class="org-src-container">

<pre class="src src-scheme"><span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">1</span>

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">&#966;</span> 0.0)
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">&#969;</span> (/ &#960; 10.0))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">? phase at sample n = 10</span>

(+ (* &#969; 10) &#966;)

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">2</span>

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-1-period</span> 20)
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-2-period</span> 30)

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">? period of sum</span>

(lcm sinusoid-1-period sinusoid-2-period)

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">3</span>

(amp-&gt;dB 1.5)
(amp-&gt;dB 2)
(amp-&gt;dB 3)
(amp-&gt;dB 5)

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">4</span>

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-1-rms-amplitude</span> 3)
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">signal-2-rms-amplitude</span> 4)

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">? rms amplitude of signals sum</span>

(sqrt (+ (* signal-1-rms-amplitude signal-1-rms-amplitude)
         (* signal-2-rms-amplitude signal-2-rms-amplitude)))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">let's double-check with real signal</span>
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s1</span> (*~ (~&lt; (* signal-1-rms-amplitude (sqrt 2)))
               (osc:sine/// 440.0)))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s2</span> (*~ (~&lt; (* signal-2-rms-amplitude (sqrt 2)))
               (osc:sine/// 543.0)))

(define-values (s1* measure-s1-rms) (rms-amplitude 0.1 s1))
(define-values (s2* measure-s2-rms) (rms-amplitude 0.1 s2))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">ss</span> (+~ s1* s2*))

(define-values (ss* measure-ss-rms) (rms-amplitude 0.1 ss))

(play! (*~ ss* silence))
(h!)

(measure-s1-rms) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; #(2.9999999999627187 2.9999999999627187)</span>
(measure-s2-rms) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; #(3.998132153590563 3.998896233813645)</span>
(measure-ss-rms) <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">=&gt; #(5.0258347452181065 5.0260213046152185)</span>

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">5</span>

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">amp-factor</span> (/ (dB-&gt;amp 9.0) (dB-&gt;amp 0.0)))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">amp-factor of n equal uncorrelated signals sum is (sqrt n)</span>

(* amp-factor amp-factor)

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">6</span>

(/ (* 2&#960; 440.0) 44100.0)

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">7</span>

(- (midi-pitch-&gt;frequency 61)
   (midi-pitch-&gt;frequency 60))

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">8</span>

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">wtf is cents</span>

<span style="font-weight: bold; font-style: italic;">;;; </span><span style="font-weight: bold; font-style: italic;">9</span>

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">min (/ (sqrt N))</span>
<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">max 1</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Wavetables and samplers</h2>
<div class="outline-text-2" id="text-2">
<p>
In <b>𝔄𝔏</b> we trade sample-number precision in table pickup for uniform use of
time. Wavetable lookup then receive position in table in range unit of <code>[0.0,
  1.0)</code> and pick nearest sample at that ratio of table length, rounded down.
</p>

<p>
Note our implementation is mono, which is not consistent with <b>𝔄𝔏</b> other
signal creators. We will refine it later.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">clamp</span> value start end)
  (<span style="font-weight: bold;">cond</span>
   [(&lt; value start) start]
   [(&gt; value end) end]
   [else value]))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">unit-&gt;length</span> x n)
  (flonum-&gt;fixnum (fltruncate (fl* x n))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">wavetable-lookup</span> table position)
  (<span style="font-weight: bold;">let*</span> ([n (fixnum-&gt;flonum (vector-length table))]
         [expand (cut unit-&gt;length &lt;&gt; n)]
         [clamp (cut clamp &lt;&gt; 0 (- n 1))])
    (~&lt; (-&gt;&gt; (&lt;~ position)
             (expand)
             (clamp)
             (vector-ref table)))))
</pre>
</div>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> The Wavetable Oscillator</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Let's make a table and try to play it in different ways. We are going to
precompute sinusoid wave to have sanity check for our <code>wavetable-lookup</code>.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">frequency</span> 440.0)

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid</span> (osc:sine/// frequency))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">wavetable-quality-factor</span> 16)

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">N</span> (exact (round (* wavetable-quality-factor (/ *sample-rate* frequency)))))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-table</span> (make-vector N))

(do-ec (: i N)
       (vector-set! sinusoid-table i (sinusoid (/ i *sample-rate* wavetable-quality-factor) 0)))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-wavetable</span>
  (wavetable-lookup sinusoid-table (osc:phasor frequency)))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">should sound the same</span>
(play! sinusoid)
(play! sinusoid-wavetable)

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-wavetable-fast</span>
  (wavetable-lookup sinusoid-table (osc:phasor (* 2.0 frequency))))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">should sound the same</span>
(play! (osc:sine/// (* 2.0 frequency)))
(play! sinusoid-wavetable-fast)

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-wavetable-slow</span>
  (wavetable-lookup sinusoid-table (osc:phasor (* 0.5 frequency))))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">should sound the same</span>
(play! (osc:sine/// (* 0.5 frequency)))
(play! sinusoid-wavetable-slow)

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-wavetable-tri</span>
  (wavetable-lookup
   sinusoid-table
   (amplitude-&gt;phase (osc:tri/// frequency))))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">now they should sound different</span>
(play! (osc:tri/// frequency))
(play! sinusoid-wavetable-tri)

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-wavetable-sine</span>
  (wavetable-lookup
   sinusoid-table
   (amplitude-&gt;phase (osc:sine/// 110.0))))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">should sound different</span>
(play! (osc:sine/// 110.0))
(play! sinusoid-wavetable-sine)

(h!)
</pre>
</div>

<p>
Now let's try cross-fade two wavetables.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">unroll*</span> signal frequency quality-factor)
  (<span style="font-weight: bold;">let*</span> ([N (exact (round (* quality-factor (/ *sample-rate* frequency))))]
         [table (make-vector N)])
    (do-ec (: i N)
           (vector-set!
            table i
            (signal (/ i *sample-rate* quality-factor) 0)))
    (cut wavetable-lookup table &lt;&gt;)))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">unroll</span> (cut unroll* &lt;&gt; &lt;&gt; 16))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s1*</span> (osc:sine/// 440.0))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s2*</span> (osc:tri/// 440.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">w1</span> (unroll s1* 440.0))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">w2</span> (unroll s2* 440.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">p</span> (osc:phasor 440.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s1</span> (w1 p))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s2</span> (w2 p))

(play! s1)
(play! s2)

(define-values (toggle toggle!) (switch))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">ramp</span> (env:linear-transition (~&lt; 2.0) toggle))

(play! (mix s1 (*~ ramp (-~ s2 s1))))

(toggle!)

(play! (mix s1* (*~ ramp (-~ s2* s1*))))

(toggle!)

(h!)
</pre>
</div>

<p>
Theoretically <code>wavetable-quality-factor</code> of 1 should be enough to rebuild
sinusoid without artifacts, but in my experiments 16 was the lowest value for
clear signal. Is it because of table being non-time-aligned? If so,
interpolating table should help.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">wavetable-lookup-linear</span> table position)
  (<span style="font-weight: bold;">let*</span> ([N (vector-length table)]
         [n (fixnum-&gt;flonum N)])
    (~&lt; (<span style="font-weight: bold;">let</span> ([p (* n (&lt;~ position))])
          (<span style="font-weight: bold;">let</span> ([i (flonum-&gt;fixnum (fltruncate p))]
                [a (mod p 1.0)])
            (+ (* (- 1.0 a) (vector-ref table (mod i N)))
               (* a (vector-ref table (mod (+ i 1) N)))))))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">unroll*</span> signal frequency quality-factor)
  (<span style="font-weight: bold;">let*</span> ([N (exact (round (* quality-factor (/ *sample-rate* frequency))))]
         [table (make-vector N)])
    (do-ec (: i N)
           (vector-set!
            table i
            (signal (/ i *sample-rate* quality-factor) 0)))
    (cut wavetable-lookup-linear table &lt;&gt;)))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">unroll</span> (cut unroll* &lt;&gt; &lt;&gt; 1))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-table</span> (unroll (osc:sine/// 440.0) 440.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s</span> (sinusoid-table (osc:phasor 440.0)))

(play! tuner)
(play! s)

(h!)
</pre>
</div>

<p>
Yes! It works!
</p>

<p>
Now, let's write channel-aware <code>unroll</code> and wavetable lookup, which we'll call sampler.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">sampler</span> table phase)
  (<span style="font-weight: bold;">let*</span> ([N (vector-length (vector-ref table 0))]
         [n (fixnum-&gt;flonum N)])
    (~&lt; (<span style="font-weight: bold;">let</span> ([p (* n (&lt;~ phase))])
          (<span style="font-weight: bold;">let</span> ([i (flonum-&gt;fixnum (fltruncate p))]
                [a (mod p 1.0)]
                [table (channel-ref table)])
            (+ (* (- 1.0 a) (vector-ref table (mod i N)))
               (* a (vector-ref table (mod (+ i 1) N)))))))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">unroll</span> signal base-frequency)
  (<span style="font-weight: bold;">let*</span> ([n (-&gt; *sample-rate* (/ base-frequency) (round) (exact))]
         [table (make-channel-vector)])
    (do-ec (: channel *channels*)
           (channel-set! table (make-vector n)))
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">channel is in inner loop because many `signal' functions</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">rely on ordered sample-by-sample execution</span>
    (do-ec (: sample n)
           (: channel *channels*)
           (vector-set!
            (channel-ref table)
            sample
            (signal (/ sample *sample-rate*) channel)))
    (cut sampler table &lt;&gt;)))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-table</span> (unroll (osc:sine/// 440.0) 440.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s</span> (sinusoid-table (osc:phasor 440.0)))

(play! tuner)
(play! s)

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Sampling</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The Transposition Formulas for Looping Wavetables.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">transposition-factor</span> table frequency)
  (/ (* (vector-length table) frequency) *sample-rate*))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">transposition-halfsteps</span> table frequency)
  (* 12.0 (log (transposition-factor table frequency) 2.0)))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">transposition-frequency</span> table halfsteps)
  (/ (* (expt 2.0 (/ halfsteps 12.0)) *sample-rate*) (vector-length table)))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">transposition-table-length</span> frequency halfsteps)
  (/ (* (expt 2.0 (/ halfsteps 12.0)) *sample-rate*) frequency))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Enveloping samplers</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-table</span> (unroll (osc:sine/// 55.0) 55.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s</span> (sinusoid-table (amplitude-&gt;phase (osc:sine/// 440.0))))

(play! tuner)
(play! s)

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Timbre stretching</h3>
<div class="outline-text-3" id="text-2-4">
<p>
For that exercise we need to extend our <code>sampler</code> to accept arbitrary <code>N</code>
instead of having it strictly equal table length, and also use <code>clamp</code>
instead of <code>wrap</code> (implemented by <code>mod</code> earlier). Another useful signal
transformer would be <code>phase-&gt;interval</code> which projects unit interval to
arbitrary one. Combining clamping sampler and interval projection we could
achieve any desired padding of table. Then we need just to superpose such
padded tables with phase shift to get desired effect.
</p>

<p>
Another small improvement is to make unroll to return just table, not a
partially applied sampler. It would enable us to experiment with different
sample implementations without re-implementing unroll.
</p>

<div class="org-src-container">

<pre class="src src-scheme">(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">clamp</span> value start end)
  (<span style="font-weight: bold;">cond</span>
   [(&lt; value start) start]
   [(&gt; value end) end]
   [else value]))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">sampler</span> table phase)
  (<span style="font-weight: bold;">let*</span> ([N (vector-length (vector-ref table 0))]
         [N-1 (- N 1)]
         [n (fixnum-&gt;flonum N)])
    (~&lt; (<span style="font-weight: bold;">let</span> ([position (* n (&lt;~ phase))])
          (<span style="font-weight: bold;">let</span> ([i (-&gt; position
                       (fltruncate)
                       (flonum-&gt;fixnum)
                       (clamp 0 N-1))]
                [a (mod position 1.0)]
                [table (channel-ref table)])
            (+ (* (- 1.0 a) (vector-ref table i))
               (* a (vector-ref table (mod (+ i 1) N)))))))))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">unroll</span> signal base-frequency)
  (<span style="font-weight: bold;">let*</span> ([n (-&gt; *sample-rate* (/ base-frequency) (round) (exact))]
         [table (make-channel-vector)])
    (do-ec (: channel *channels*)
           (channel-set! table (make-vector n)))
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">channel is in inner loop because many `signal' functions</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">rely on ordered sample-by-sample execution</span>
    (do-ec (: sample n)
           (: channel *channels*)
           (vector-set!
            (channel-ref table)
            sample
            (signal (/ sample *sample-rate*) channel)))
    table))

(define~ (phase-&gt;interval phase start end)
  (<span style="font-weight: bold;">let</span> ([phase (&lt;~ phase)]
        [start (&lt;~ start)]
        [end (&lt;~ end)])
    (+ start (* phase (- end start)))))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">sinusoid-table</span> (unroll (osc:sine/// 440.0) 440.0))

(<span style="font-weight: bold;">define</span> (<span style="font-weight: bold;">make-control</span> x)
  (<span style="font-weight: bold;">let-values</span> ([(signal setter) (ctrl:make-control x)])
    (values
     (env:linear-transition (~&lt; 0.05) signal)
     setter)))

(define-values (frequency set-frequency!) (make-control 440.0))

(define-values (start1 set-start1!) (make-control 0.0))
(define-values (end1 set-end1!) (make-control 1.0))

(define-values (start2 set-start2!) (make-control 0.0))
(define-values (end2 set-end2!) (make-control 1.0))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">phasor1</span> (phase-&gt;interval
                 (osc:phasor frequency)
                 start1
                 end1))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">phasor2</span> (phase-&gt;interval
                 (osc:phasor frequency)
                 start2
                 end2))

(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s1</span> (sampler sinusoid-table phasor1))
(<span style="font-weight: bold;">define</span> <span style="font-weight: bold;">s2</span> (sampler sinusoid-table phasor2))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">^v^v^</span>
(play! tuner)
(play! s1)

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">....^v^v^....</span>
(set-start1! -1.0)
(set-end1! 2.0)

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">^v^v^...</span>
<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">...^v^v^</span>
(set-start1! 0.0)
(set-end1! 1.5)
(set-start2! -0.5)
(set-end2! 1.0)
(set-frequency! 220.0)
(play! (mix s1 s2))

<span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">^v^</span>
(play! s1)
(set-start1! 0.3)
(set-end1! 0.6)
(set-frequency! 440.0)

(h!)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> Interpolation</h3>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> Examples</h3>
</div>
<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7"><span class="section-number-3">2.7</span> Exercises</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ruslan Prakapchuk</p>
<p class="date">Created: 2017-10-25 Wed 19:34</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
